<?php
    /**
     * @file      帳票- 商品別在庫数詳細画面(View)
     * @author    川橋
     * @date      2019/03/08
     * @version   1.00
     * @note      帳票 - 商品別在庫数詳細画面
     */
?>
<!DOCTYPE html>
<html>
    <head>
        <?php
            $fileNames = array('default.css'); // cssまたはｊｓファイルを拡張子付きで配列に記述
            include("../profit/View/Common/HtmlHeader.php");
        ?>

        
        
    <script src="../js/profit/jquery/jquery.ui.ympicker.js" ></script>
    <script src="../js/profit/jquery/jquery-migrate-1.0.0.js" ></script>
    <script src="../js/profit/jquery/datepicker-ja.js" ></script>
    <script src="../js/autofil_v<?php echo $_SESSION['AUTOFIL_VER'] ?>.js" ></script>
    <!-- modal script-->
    <script src="../js/modal/modal.js" ></script>
    <link rel="stylesheet" href="../css/modal/modal.css" >    

    <script type="text/javascript">
        Sizelist       = '<?php echo json_encode(json_encode($Sizelist)); ?>';
        A_Sizelist     = JSON.parse(Sizelist.slice(1,-1));
        porg_id_list        = '<?php echo json_encode(json_encode($org_id_list)); ?>';
        data_org            = JSON.parse(porg_id_list.slice(1,-1)); 
        ptypprod_detail     = '<?php echo json_encode($prod_detail); ?>';
        data_prod           = JSON.parse(ptypprod_detail);  
        ptypsect_detail     = '<?php echo json_encode($sect_detail); ?>';
        data_sect           = JSON.parse(ptypsect_detail);  
        searchArray         = '<?php echo json_encode($searchArray); ?>';
        A_searchArray       = JSON.parse(searchArray);
        param               = '<?php echo json_encode($param); ?>';
        A_param             = JSON.parse(param);
          // インジケーター
        lording_default_message = '検索しています。。。。';
        //    = 'データを取得しています。。。。';
        var prod_list = A_searchArray["prod_cd"].replace('false','');
        if(prod_list){
            prod_list = ","+prod_list;
            data_select['prod'] = prod_list;
        }
        var sect_list = A_searchArray["sect_cd"].replace('false','');
        if(sect_list){
            sect_list = ","+sect_list;
            data_select['sect'] = sect_list;
        }
        var org_list = A_searchArray["org_id"].replace('false',''); 
        if(org_list){
            org_list = ","+org_list;
            data_select['org'] = org_list;
        }
        
            function radio_change_management(){
                var prev = [];
                document.getElementById("serchTable").addEventListener('change', function(e) {
                    //console.log('Previous:', prev[e.target.name] ? prev[e.target.name].value : null);
                    //console.log(e);
                    if(e.target.name === "period"){
                        if(!prev[e.target.name]){
                            old_id_start="start_date";
                            old_id_end="end_date";                              
                        }else if(prev[e.target.name].value === "day"){
                            old_id_start="start_date";
                            old_id_end="end_date";                            
                        }else if(prev[e.target.name].value === "month"){
                            old_id_start="start_date";
                            old_id_end="end_date";  
                        }else if(prev[e.target.name].value === "year"){
                            old_id_start="start_year";
                            old_id_end="end_year";
                        }
                        document.getElementById(old_id_start).hidden=true;
                        document.getElementById(old_id_end).hidden=true;
                        document.getElementById(old_id_start).value="";
                        document.getElementById(old_id_end).value="";                                                
                        if(e.target.value === "day"){
                            date_mode = "date";
                            new_id_start="start_date";
                            new_id_end="end_date"; 
                            // checkbox checked
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,10).replace(/-/g,"\/"); 
                            today.setMonth(today.getMonth()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,10).replace(/-/g,"\/");                            
                        }else if(e.target.value === "month"){
                            date_mode = "dateM";
                            new_id_start="start_date";
                            new_id_end="end_date";
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,7).replace(/-/g,"\/"); 
                            today.setMonth(today.getMonth()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,7).replace(/-/g,"\/");                                                        
                        }else if(e.target.value === "year"){
                            date_mode = "year";
                            new_id_start="start_year";
                            new_id_end="end_year";
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,4).replace(/-/g,"\/"); 
                            today.setFullYear(today.getFullYear()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,4).replace(/-/g,"\/");                                                                                    
                        }         
                        document.getElementById(new_id_start).hidden=false;
                        document.getElementById(new_id_end).hidden=false;                        
                    }else if(e.target.name === "org_r"){
                        document.getElementById("tenpo").checked = false;
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }
                        document.getElementById("org_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("org_select").disabled=false;
                        }else if(e.target.value === "compile"){
                            document.getElementById("tenpo").checked = true;
                        }  
                    }else if(e.target.name === "sect_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }                        
                        document.getElementById("sect_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("sect_select").disabled=false;
                        }
                    }else if(e.target.name === "prod_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }                        
                        document.getElementById("prod_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("prod_select").disabled=false;
                        }
                    }
                    prev[e.target.name] = e.target;
                });
            }
//ADDSTR kanderu 2020/09/04    
        function sort(field){
            if(sort_table.value.indexOf(field) === -1){
                sort_table.value = field+" asc";
            }else{
                if(sort_table.value.indexOf("asc") !== -1){
                    sort_table.value = field+" desc";
                }else{
                    sort_table.value = field+" asc";
                }
            }
            var frm = document.serchForm;
            frm.onbtn.value = 'serch';
            frm.search.value = 'sort';
              
            console.log("sort_table: "+sort_table.value);
            chf(frm);            
        }               
//ADDEND kanderu 2020/09/04      
        function chf(frm){
            
            if( 1 < window.location.search.length )
                {
                    csv_data.value = '';
                    // modal data
                    elem_str_date = document.getElementById("start_date").value.replace(/\//g,"");
                    elem_end_date = document.getElementById("end_date").value.replace(/\//g,"");
                    if(elem_str_date === ""){
                        alert("日付を入力してください。");
                        document.getElementById("start_date").focus();
                        return false;
                    }else if(elem_end_date === ""){
                        alert("日付を入力してください。");
                        document.getElementById("end_date").focus();
                        return false;
                    }
                    if(elem_str_date > elem_end_date){
                        alert("期間指定が不正です。開始日が終了日を超えています。");
                        document.getElementById("start_date").value="";
                        document.getElementById("start_date").focus();
                        return false;
                    } 																								  
                    // org_id
                    if(org_r_selected.checked){
                        // list org name
                        for(i=0;i<org_select.options.length;i++){
                            if( !isNaN(org_select.options[i].value) ){
                                org_nm_lst.value = org_nm_lst.value + ','+org_select.options[i].innerText;
                            }
                        } 
                        org_nm_lst.value = org_nm_lst.value.replace(/^,/,"");  
                        org_id.value = org_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!org_list){
                            alert("店舗を選択してください。");
                            return false;
                        }
                    }else{
                        org_id.value = false;
                    }

                    // prod_cd                    
                    if(prod_r_selected.checked){
                        // list prod name
                        for(i=0;i<prod_select.options.length;i++){
                            if( !isNaN(prod_select.options[i].value) ){
                                prod_nm_lst.value = prod_nm_lst.value + ','+prod_select.options[i].innerText;
                            }
                        }
                        prod_nm_lst.value = prod_nm_lst.value.replace(/^,/,"");
                        prod_cd.value = prod_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!prod_list){
                            alert("商品を選択してください。");
                            return false;
                        }
                    }else{
                        prod_cd.value = false;
                    }
                    
                    // sect_cd                    
                    if(sect_r_selected.checked){
                        // list sect name
                        for(i=0;i<sect_select.options.length;i++){
                            if( !isNaN(sect_select.options[i].value) ){
                                sect_nm_lst.value = sect_nm_lst.value + ','+sect_select.options[i].innerText;
                            }
                        }
                        sect_nm_lst.value = sect_nm_lst.value.replace(/^,/,"");
                        sect_cd.value = sect_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!sect_list){
                            alert("部門を選択してください。");
                            return false;
                        }
                    }else{
                        sect_cd.value = false;
                    }
  // 最初の1文字 (?記号) を除いた文字列を取得する
                    var query = window.location.search.substring( 1 );
                    var action = frm.action.split( '?' );

                    // 検索以外の機能実行後だった場合、パラメータを補正する
                    if(1 < action.length){
                        frm.action = action[0];
                    }

                    // クエリの区切り記号 (&) で文字列を配列に分割する
                    var parameters = query.split( '&' );
                    if (frm.onbtn.value == 'serch') {
                        frm.target='_self';
                        if(1 < parameters.length){
                             frm.action += '?param=' +frm.elements["codeName"].value + '&home=1';
                         }else{
                             frm.action += '?param=' +frm.elements["codeName"].value;
                        }
                    }else if (frm.onbtn.value == 'csvoutput'){
                        header_text = header_h.getElementsByTagName('tr')[0].innerText.replace(' ▲',"").replace(' ▼',"").replace(/[\n,\r]/g,'').replace(/\t/g,",");
                        elem_tr_list = data.getElementsByTagName('tr');
                        data_send = [];
                        var csv_data_o = {};
                        csv_data_o['"0"'] = header_text;
                        var row_nb = 1;
//ADDSTR 2020/09/25 kanderu
                var list_nm = '';  //店舗リスト用の変数
//ADDEND 2020/09/25 kanderu 
                        for(i=0;i<elem_tr_list.length;i++){
                            if(elem_tr_list[i].style.backgroundColor){
                                //console.log(elem_tr_list[i]);
                                continue;
                            }                            
//EDITSTR 2020/09/25 kanderu
                    //csv_data_o['"'+row_nb+'"'] = '"'+elem_tr_list[i].innerText.replace(/\t/g,'","')+'"'; 
                    
		                    if(elem_tr_list[i].getElementsByTagName('td')[1].innerText !== ''){
		                        list_nm = elem_tr_list[i].getElementsByTagName('td')[1].innerText;　//CSV出力の時店舗名の行を空ないの場合、普通の店舗名を表示
		                        csv_data_o['"'+row_nb+'"'] = '"'+elem_tr_list[i].innerText.replace(/\t/g,'","')+'"';
		                    }else{
		                        elem_tr_list[i].getElementsByTagName('td')[1].innerText = list_nm;　//店舗名を表示して保持
		                        csv_data_o['"'+row_nb+'"'] = '"'+elem_tr_list[i].innerText.replace(/\t/g,'","')+'"';
		                        elem_tr_list[i].getElementsByTagName('td')[1].innerText = '';　//CSV出力の時行が空の場合、保持した店舗名を空の行を埋めます
		                    }
//EDITEND 2020/09/25 kanderu
                            row_nb +=1;
                        }
                        //console.log(csv_data_o);
                        csv_data.value = JSON.stringify(csv_data_o);                         
                        if(1 < parameters.length){
                             frm.action += '?param=LedgerSheetProductHistory/csvoutput&home=1';
                         }else{
                             frm.action += '?param=LedgerSheetProductHistory/csvoutput';
                        }
                        //return false;
                    }
//ADDSTR kanderu 2020/09/04  
                    if(frm.search.value === 'sort'){
                       frm.submit();
                   } 
//ADDEND kanderu 2020/09/04                     
                }
       }
    /**
     *  イベント制御用
     *
     */
    function set_value(s_val){
        document.serchForm.onbtn.value = s_val;
    }

    /**
     * DatePickerを設定
     */
    $(function()
    {
        $( "#start_date, #end_date" ).datepicker({
            numberOfMonths: 2,
            showCurrentAtPos: 1,
            showButtonPanel: true,
            dateFormat: 'yy/mm/dd'
        });
    });

    /**
     *
      * 画面生成時自動読み込み
     *
     */
    $(function() {
        $("#start_dateM").ympicker({
            altField: "#start_dateM" //リターンセットUI IDorCLASS名
            ,altFormat: "yy/mm" //リターン日付形式
            ,monthNamesShort: ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]  //カレンダー表示月形式
            ,showAnim: "slideDown" //表示アニメーション形式
            ,yearRange: "c-2:c+3" //プルダウン年範囲
        });
    });
    $(function() {
        $("#end_dateM").ympicker({
            altField: "#end_dateM" //リターンセットUI IDorCLASS名
            ,altFormat: "yy/mm" //リターン日付形式
            ,monthNamesShort: ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]  //カレンダー表示月形式
            ,showAnim: "slideDown" //表示アニメーション形式
            ,yearRange: "c-2:c+3" //プルダウン年範囲
        });
    });
    
    /**
     *
     * スクロール制御
     *
     */
        function SyncScroll(/* elem1, elem2, ... */) {
            this._elements = [];
            this._elementOnscroll = this._elementOnscroll.bind(this);
            this.addElement.apply(this, arguments);
        }
        SyncScroll.prototype = {
            enableHorizontal: true,
            enableVertical: true,
            addElement: function (/* elem1, elem2, ... */) {
                var elem, i;
                for (i = 0; i < arguments.length; i += 1) {
                    elem = arguments[i];
                    elem.addEventListener('scroll', this._elementOnscroll, false);
                    this._elements.push(elem);
                }
            },
            removeElement: function (/* elem1, elem2, ... */) {
                var elem, i, j;
                for (i = 0; i < arguments.length; i += 1) {
                    elem = arguments[i];
                    elem.removeEventListener('scroll', this._elementOnscroll, false);
                    j = this._elements.indexOf(elem);
                    if (j >= 0) {
                        this._elements.splice(j, 1);
                    }
                }
            },
            _elementOnscroll: function (event) {
                var i,
                    elems = this._elements,
                    elem = event.target,
                    x = elem.scrollLeft,
                    y = elem.scrollTop;
                if (this.enableHorizontal) {
                    for (i = 0; i < elems.length; i += 1) {
                        elem = elems[i];
                        if (elem === event.target || elem.scrollLeft === x) {
                            continue;
                        }
                        elem.scrollLeft = x;
                        if (elem.scrollLeft !== x) {
                            elem.scrollLeft = x + x - elem.scrollLeft;
                        }
                    }
                }
                if (this.enableVertical) {
//                    Edit 2017/11/27 kanderu 上部のスクロールを下部で停止
                    for (i = 0; i < elems.length; i += 2) {
                        elem = elems[i];
                        if (elem === event.target || elem.scrollTop === y) {
                            continue;
                        }
                        elem.scrollTop = y;
                        if (elem.scrollTop !== y) {
                            elem.scrollTop = y + y - elem.scrollTop;
                        }
                    }
                }
            },
            destroy: function () {
                this.removeElement.apply(this, this._elements);
            }
        };

        window.onload = function () {
              modal_lording.hidden = false;
            creat_listener();
            radio_change_management();
            prod_array = [];
            if(A_param["prod_r"] === ""){
                code_list = prod_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["prod_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    prod_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("prod_select",prod_array);
            if(prod_list){
                prod_r_selected.checked = true;
                prod_select.disabled = false;
            }
            if(A_param["prod_select"] && A_param["prod_select"] !== 'empty'){
                prod_select.value = A_param["prod_select"];
            }
            
            sect_array = [];
            if(A_param["sect_r"] === ""){
                code_list = sect_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["sect_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    sect_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("sect_select",sect_array);
            if(sect_list){
                sect_r_selected.checked = true;
                sect_select.disabled = false;
            }
            if(A_param["sect_select"] && A_param["sect_select"] !== 'empty'){
                sect_select.value = A_param["sect_select"];
            }
            
            org_array = [];
            if(A_param["org_r"] === ""){
                code_list = org_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["org_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    org_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("org_select",org_array);
            if(org_list){
                org_r_selected.checked = true;
                org_select.disabled = false;
            }
            if(A_param["org_select"] && A_param["org_select"] !== 'empty'){
                org_select.value = A_param["org_select"];
            } 
            if(A_searchArray['tenpo']){
                document.getElementById("tenpo").checked = true;
                org_r_compile.checked = true;
            } 
            //EDITSTR kanderu 2020/09/04 
            lording_message.innerHTML = lording_default_message;
   
              
               if(A_param["sort_table"]){
                sort_table.value = A_param["sort_table"];
            }else{
                sort_table.value = 'organization_id asc';
            }
            sort_table_split = sort_table.value.split(" ");
            if(sort_table_split[1] === 'asc'){
                document.getElementById('sort_'+sort_table_split[0]).innerHTML += ' ▲';
            }else{
                document.getElementById('sort_'+sort_table_split[0]).innerHTML += ' ▼';
            }      
//EDITEND kanderu 2020/09/04                
            document.getElementById('start_date').value = A_searchArray['start_date'];
            document.getElementById('end_date').value = A_searchArray['end_date'];
            if (A_searchArray['prt_type'] === '1'){
                document.getElementById('prt_type').checked = true;
            }
            
            if(A_searchArray['history_chk_hai']){history_chk_hai.checked = true;}
            if(A_searchArray['history_chk_haie']){history_chk_haie.checked = true;}
            if(A_searchArray['history_chk_ji']){history_chk_ji.checked = true;}
            if(A_searchArray['history_chk_jie']){history_chk_jie.checked = true;}
            if(A_searchArray['history_chk_mi']){history_chk_mi.checked = true;}
            if(A_searchArray['history_chk_mie']){history_chk_mie.checked = true;}
            if(A_searchArray['history_chk_nyu']){history_chk_nyu.checked = true;}
            if(A_searchArray['history_chk_sa']){history_chk_sa.checked = true;}
            if(A_searchArray['history_chk_sae']){history_chk_sae.checked = true;}
            if(A_searchArray['history_chk_shi']){history_chk_shi.checked = true;}
            if(A_searchArray['history_chk_shie']){history_chk_shie.checked = true;}
            if(A_searchArray['history_chk_shu']){history_chk_shu.checked = true;}
            if(A_searchArray['history_chk_ta']){history_chk_ta.checked = true;}
            if(A_searchArray['history_chk_u']){history_chk_u.checked = true;}
            if(A_searchArray['history_chk_ue']){history_chk_ue.checked = true;}
            modal_lording.hidden = true;
            
         //   
            // 縦方向のみ
            var sample2_1 = document.getElementById('header_h');
            var sample2_2 = document.getElementById('data');
            var syncScroll2 = new SyncScroll(sample2_1, sample2_2);
            syncScroll2.enableHorizontal = false;

            // 横方向のみ
            var sample3_1 = document.getElementById('header_h');
            var sample3_2 = document.getElementById('data');
            var syncScroll3 = new SyncScroll(sample3_1, sample3_2);
            syncScroll3.enableVertical = false;
        };

        
       // asc=[];
       // sort_col_list="";
    </script>

    <STYLE type="text/css">
        
        .serchListArea tr:nth-child(even) td { background: transparent; }
        #header_h {
           width:98%;
           overflow-x:hidden;overflow-y:hidden;
           }
        #header_v {
           width:90px;height:650px;
           overflow-x:scroll;overflow-y:hidden;
           text-align: left;
           }
        #data {
           width:99%;
           max-height:550px;
           overflow-x:scroll;overflow-y:scroll;
           table-layout: fixed;
           }
        .serchTableTitle{

        }
        .serchTableItem{
            
        }
		#prod_select{
		    max-width: 130px;
                }  
/*//EDITSTR kanderu 2020/09/04                    */
        th {
        cursor: pointer;
       }
         /* ローディングメッセージ */
            .loader {
              float: left;
              border: 16px solid #f3f3f3;
              border-radius: 50%;
              border-top: 16px solid #3498db;
              width: 50px;
              height: 50px;
              -webkit-animation: spin 2s linear infinite; /* Safari */
              animation: spin 2s linear infinite;
            }

            /* Safari */
            @-webkit-keyframes spin {
              0% { -webkit-transform: rotate(0deg); }
              100% { -webkit-transform: rotate(360deg); }
            }

            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            .css_lording{
                background-color: #0D0D70;
                color: white;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 270px;
                overflow: hidden;   
                border-radius: 6px;
                margin-top: 300px;
            }
            #modal_lording{
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                padding-top: 100px; /* Location of the box */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */                
            }
/* //EDITEND kanderu 2020/09/04    */
    </STYLE>

    </head>
    <body>
<?php
if( isset($_GET['home']) ) {
    if( "1" ==  $_GET['home'] ){
        include("../home/View/Common/PageHeader.php");
    }else{
        include("Common/PageHeader.php");
    }
}else{
        include("Common/PageHeader.php");
}
?>
<?php
    $checked = '';
    if (isset($_POST['tenpo'])){
        $checked = ' checked';
    }
?>

<!-- Site -->
<div id="sb-site">
    <!-- menuNameArea -->
    <!-- /.menuNameArea -->
<form name="serchForm" id="serchForm" action="/profit/index.php" method="post" onsubmit="return chf(this)">
<div class="serchListArea">
<table align="center">
    <tr>
        <td>
            <table id="serchTable">
                <tr>
                    <th class="serchTableTitle" align="left" width="65">帳票</th>
                    <td class="serchTableItem" align="left" width="120">
                        商品履歴表
                        <input type="hidden" name="codeName" id="codeName" value="LedgerSheetProductHistory/show">
                    </td>
                    <th class="serchTableTitle" align="left" width="65">期間指定</th><!--文字修正　2019/12/01　柴田-->
                    <td class="serchTableItem" width="260"> <!--文字修正　2019/12/01　柴田-->
                        <input type="text" pattern="\d{4}/\d{2}/\d{2}" title="西暦/月の形式で入力してください。" id="start_date" name="start_date" size="10" >
                        <input type="text" pattern="\d{4}/\d{2}/\d{2}" title="西暦/月の形式で入力してください。" id="end_date" name="end_date" size="10" >
                    </td>
                    <th class="serchTableTitle" align="center" width="65">グループ<br />選択</th>
                    <td align="left" width=220>
                            <!--
                            <input type="radio" name="org_r" id="org_r_compile" value="compile"> 企業計<br />
                            -->
                            <input type="radio" name="org_r" id="org_r_all" value="all" checked> 全店<br />
                            <input type="radio" name="org_r" id="org_r_selected" value=""> 店舗指定&nbsp;&nbsp;
                            <select id="org_select" name="org_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                            <input type="checkbox" name="tenpo" value="Yes" id="tenpo" hidden>
                            <input type="text" name="org_id" value="" id="org_id" hidden>
                            <input type="text" name="org_nm_lst" value="" id="org_nm_lst" hidden> 
                    </td>
                    <th class="serchTableTitle" align="left" width="65">部門選択</th>
                    <td class="serchTableItem" width=200>
                        <input type="radio" name="sect_r" id="sect_r_all" value="all" checked> 全部門<br />
                        <input type="radio" name="sect_r" id="sect_r_selected" value=""> 部門指定&nbsp;&nbsp;
                        <select id="sect_select" name="sect_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>                        
                        <input type="text" name="sect_cd" value="" id="sect_cd" hidden>
                        <input type="text" name="sect_nm_lst" value="" id="sect_nm_lst" hidden> 
                    </td>                    
                </tr>
                <tr>                    
                    <th class="serchTableTitle" align="center" width="65">商品選択</th>
                    <td class="serchTableItem" width=280>
                        <input type="radio" name="prod_r" id="prod_r_all" value="all" checked> 全商品<br />
                        <input type="radio" name="prod_r" id="prod_r_selected" value=""> 商品指定&nbsp;&nbsp;
                        <select id="prod_select" name="prod_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>                        
                        <input type="text" name="prod_cd" value="" id="prod_cd" hidden>
                        <input type="text" name="prod_nm_lst" value="" id="prod_nm_lst" hidden> 
                    </td>
                    <th id="itemtitle" class="serchTableTitle" align="center" width="65">項目選択</th>
                    <td colspan='4' id="itemcond" class="serchTableItem" width=280>
                            <input type="checkbox" name="history_chk_u" value="1" id="history_chk_u"  >&nbsp;売上　　　　
                            <input type="checkbox" name="history_chk_shi" value="1" id="history_chk_shi" >&nbsp;仕入　　　　
                            <input type="checkbox" name="history_chk_nyu" value="1" id="history_chk_nyu" >&nbsp;入庫　
                            <input type="checkbox" name="history_chk_hai" value="1" id="history_chk_hai" >&nbsp;廃棄　　　
                            <input type="checkbox" name="history_chk_ji" value="1" id="history_chk_ji" >&nbsp;自家消費　　　
                            <input type="checkbox" name="history_chk_sa" value="1" id="history_chk_sa" >&nbsp;サンプル　　　
                            <input type="checkbox" name="history_chk_mi" value="1" id="history_chk_mi" >&nbsp;店間移動　
                            <input type="checkbox" name="history_chk_ta" value="1" id="history_chk_ta" >&nbsp;棚卸入力<br />
                            <input type="checkbox" name="history_chk_ue" value="1" id="history_chk_ue" >&nbsp;売上返品　　
                            <input type="checkbox" name="history_chk_shie" value="1" id="history_chk_shie" >&nbsp;仕入返品　　
                            <input type="checkbox" name="history_chk_shu" value="1" id="history_chk_shu" >&nbsp;出庫　
                            <input type="checkbox" name="history_chk_haie" value="1" id="history_chk_haie" >&nbsp;廃棄返品　
                            <input type="checkbox" name="history_chk_jie" value="1" id="history_chk_jie" >&nbsp;自家消費返品　
                            <input type="checkbox" name="history_chk_sae" value="1" id="history_chk_sae" >&nbsp;サンプル返品　
                            <input type="checkbox" name="history_chk_mie" value="1" id="history_chk_mie" >&nbsp;店間移動返品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;　　　                        
    <button onclick="$('#itemcond input[type=checkbox]').prop('checked', true); return(false);">一括選択</button>
    <button onclick="$('#itemcond input[type=checkbox]').prop('checked', false); return(false);">一括解除</button>
                            
                    </td>
                    <td align=left>
                        <input class="submit" type="submit" name="search" id="search" value="検索" onClick="set_value('serch')">
                        <input type="text" name="csv_data" value="" id="csv_data" hidden>
                        <?php if( !empty($data) ) { ;?>
                        <input width=20 size=10 class="submit" type="submit" name="csvoutput" id="csvoutput" value="CSV出力"onClick="set_value('csvoutput')">
                        <?php } ?>
                        <input type="hidden" name="onbtn">
                    </td>
                </tr>
            </table>
            <!-- The Modal -->
            <div id="modal_prod" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modalproduct.html"); ?>
                </div>
            </div>
<!--ADDSTR kanderu 2020/09/04-->
            <!-- インジケーター処理 -->
            <div id='modal_lording' hidden >
                <div class="css_lording">
                    <div class="little_box">
                        <div class="loader" >
                        </div>
                    </div>
                    <div class="float_rigth">
                         <span id='lording_message'>検索しています。。。。</span><br />お待ちください。。。。
                    </div>
                </div>
            </div>
<!--ADDEND kanderu 2020/09/04-->
            
            <div id="modal_sect" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modaldepartment.html"); ?>
                </div>
            </div>
            
            <div id="modal_org" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modalorganization.html"); ?>
                </div>
            </div>             
        </td>
    </tr>
</table>
<!-- 固定ヘッダ -->
<table>
    <tr>
        <td>
            <!-- 水平ヘッダ -->
            <div id="header_h">
            <table>
                <tr>
<!--EDITSTR kanderu 2020/09/04                        -->
                    <th id="sort_proc_date"         onClick="sort('proc_date')"  width=60>日付</th>
                    <th id="sort_organization_id"   onClick="sort('organization_id')" width=70>店舗</th>
                    <th id="sort_prod_cd"           onClick="sort('prod_cd')"    width=87>商品コード</th>
                    <th id="sort_proc_nm"           onClick="sort('prod_nm')"    width=200>商品名</th>
                    <th id="sort_tax_rate"          onClick="sort('tax_rate')"    width=40>税率</th>
                    <th id="sort_den_hideseq"       onClick="sort('den_hideseq')"    width=70>伝票番号</th>
                    <th id="sort_type_nm"           onClick="sort('type_nm')"    width=70>取引種別</th>
                    <th id="sort_to_name"           onClick="sort('to_name')"    width=120>相手先</th>
                    <th id="sort_amount"            onClick="sort('amount')"    width=70>数量</th>
                    <th id="sort_unit_price"        onClick="sort('unit_price')"    width=70>単価</th>
                    <th id="sort_saleprice"         onClick="sort('saleprice')"    width=70>売価</th>
                    <th id="sort_costprice"         onClick="sort('costprice')"    width=70>原価</th>
                    <th id="sort_costprice_total"   onClick="sort('costprice_total')"    width=70>原価金額</th>
                </tr>
            </table>
                 <input type="hidden" id="sort_table" name="sort_table">   
            </div>
<!--EDITEND kanderu 2020/09/04                -->
        </td>
    </tr>
    <tr>
        <td>
            <!-- データ部分 -->
            <div id="data">
            <?php 
            if( !empty($data) ){
            ?>
            <table id='t_body_data'>
            <?php
                $proc_date  = '';
                $org_nm     = '';
                $prod_cd    = '';
                $prod_nm    = '';
                $tax_rate   = '';

                $prev_proc_date  = '';
                $prev_org_nm     = '';
                $prev_prod_cd    = '';
                
                foreach ($data as $rows) {   
                    switch($rows['type_nm']){
                        case '売上':
                            if(!$searchArray['history_chk_u']){continue 2;};
                            break;
                        case '売上返品':
                            if(!$searchArray['history_chk_ue']){continue 2;};
                            break;
                        case '仕入':
                            if(!$searchArray['history_chk_shi']){continue 2;};
                            break;
                        case '仕入返品':
                            if(!$searchArray['history_chk_shie']){continue 2;};
                            break;
                        case '入庫':
                            if(!$searchArray['history_chk_nyu']){continue 2;};
                            break;
                        case '出庫':
                            if(!$searchArray['history_chk_shu']){continue 2;};
                            break;
                        case '廃棄':
                            if(!$searchArray['history_chk_hai']){continue 2;};
                            break;
                        case '廃棄返品':
                            if(!$searchArray['history_chk_haie']){continue 2;};
                            break;
                        case '自家消費':
                            if(!$searchArray['history_chk_ji']){continue 2;};
                            break;
                        case '自家消費返品':
                            if(!$searchArray['history_chk_jie']){continue 2;};
                            break;
                        case 'サンプル':
                            if(!$searchArray['history_chk_sa']){continue 2;};
                            break;
                        case 'サンプル返品':
                            if(!$searchArray['history_chk_sae']){continue 2;};
                            break;
                        case '店間移動':
                            if(!$searchArray['history_chk_mi']){continue 2;};
                            break;
                        case '店間移動返品':
                            if(!$searchArray['history_chk_mie']){continue 2;};
                            break;
                        case '棚卸入力':
                            if(!$searchArray['history_chk_ta']){continue 2;}; 
                            break;
                    }
                    if( $prev_proc_date === $rows['proc_date']){
                        $proc_date  = '';
                    }else{
                        $proc_date = $rows['proc_date'];
                        $prev_proc_date = $rows['proc_date'];
                        $prev_org_nm = '';
                        $prev_prod_cd    = '';
                    }
                    if( $prev_org_nm === $rows['abbreviated_name']  ){
                        $org_nm = '';
                    }else{
                        $prev_org_nm  = $rows['abbreviated_name'];
                        $org_nm       = $prev_org_nm;
                        $prev_prod_cd = '';
                    }
                    if( $prev_prod_cd === $rows['prod_cd']  ){
                        $prod_cd = '';
                        $prod_nm = '';
                        $tax_rate = '';
                    }else{
                        $prev_prod_cd   = $rows['prod_cd'];
                        $prod_cd        = $prev_prod_cd;
                        $prod_nm        = $rows['prod_nm'];
                        $tax_rate        = $rows['tax_rate'];
                    }                    
                    
            ?>
                <tr>
                    <td width=60 align="left"><?php hsc($proc_date);?></td>                 
                    <!-- 店舗 -->
                    <td width=70 align="left"><?php hsc($org_nm);?></td>
                    <!-- 商品コード -->
                    <td width=87 align="left"><?php hsc($prod_cd);?></td>
                    <!-- 商品コード -->
                    <td width=200 align="left"><?php hsc($prod_nm);?></td>   
                    <!-- 税率 -->
                    <td width=40 align="left"><?php hsc($tax_rate); ?></td>   
                    <!--Edit 2019/11/27 kanderu align-->
                    <!-- 伝票番号 -->
                    <td width=70 align="left"><?php hsc($rows['den_hideseq']); ?></td>
                    <!-- Edit 2019/11/27 kanderu align-->
                    <!-- 取引種別 -->
                    <td width=70 align="left"><?php hsc($rows['type_nm']); ?></td>
                    <!--Edit 2019/11/27 kanderu align-->
                    <!-- 相手先 -->
                    <td width=120 align="left"><?php hsc($rows['to_name']); ?></td>
                    <!-- 数量 -->
                    <td width=70 align="right"><?php hsc(number_format($rows['amount']),0); ?></td>
                    <!-- 単価 -->
                    <td width=70 align="right"><?php hsc(number_format($rows['unit_price']),0); ?></td>
                    <!-- 売価 -->
                    <td width=70 align="right"><?php hsc(number_format($rows['saleprice']),0); ?></td>
                    <!-- 原価 -->
                    <td width=70 align="right"><?php hsc(number_format($rows['costprice']),0); ?></td>
                    <!-- 原価金額 -->
                    <td width=70 align="right"><?php hsc(number_format($rows['costprice_total']),0); ?></td>
                </tr>
                <?php 
                    }  // end of foreach
                ?>
            </table>
            <?php
            }
            ?>
            </div>
        </td>
    </tr>
    
</table>
</div>
</div><!-- /#sb-site -->

</body>
</html>


