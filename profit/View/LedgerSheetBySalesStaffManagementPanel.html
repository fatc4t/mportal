<?php
    /**
     * @file     
     * @author    millionet oota
     * @date      2018/06/04
     * @version   1.00
     * @note      
     */
?>
<!DOCTYPE html>
<html>
    <head>
        <?php
            $fileNames = array('default.css'); // cssまたはｊｓファイルを拡張子付きで配列に記述
            include("../profit/View/Common/HtmlHeader.php");
        ?>

    <script src="../js/profit/jquery/jquery.ui.ympicker.js" /></script>
    <script src="../js/profit/jquery/jquery-migrate-1.0.0.js" /></script>
    <script src="../js/profit/jquery/datepicker-ja.js" /></script>
    <script src="../js/autofil_v<?php echo $_SESSION['AUTOFIL_VER'] ?>.js" ></script>
    <!-- modal script-->
    <script src="../js/modal/modal.js" ></script>
    <link rel="stylesheet" href="../css/modal/modal.css" >
    <script type="text/javascript">
        Sizelist       = '<?php echo json_encode(json_encode($Sizelist)); ?>';
        A_Sizelist     = JSON.parse(Sizelist.slice(1,-1));
        
        porg_id_list        = '<?php echo json_encode(json_encode($org_id_list)); ?>';
        data_org            = JSON.parse(porg_id_list.slice(1,-1)); 
        ptypsect_detail     = '<?php echo json_encode($sect_detail); ?>';
        data_sect           = JSON.parse(ptypsect_detail); 
        ptypprod_detail     = '<?php echo json_encode($prod_detail); ?>';
        data_prod           = JSON.parse(ptypprod_detail);        
        ptypstaff_detail    = '<?php echo json_encode($staff_detail); ?>';
        data_staff          = JSON.parse(ptypstaff_detail);        
        searchArray         = '<?php echo json_encode($searchArray); ?>';
        A_searchArray       = JSON.parse(searchArray);
        param               = '<?php echo json_encode($param); ?>';
        A_param             = JSON.parse(param);
                //console.log(data_select['sect']);
        var sect_list = A_searchArray["sect_cd"].replace('false','');
        if(sect_list){
            sect_list = ","+sect_list;
            data_select['sect'] = sect_list;
        }
        var org_list = A_searchArray["org_id"].replace('false',''); 
        if(org_list){
            org_list = ","+org_list;
            data_select['org'] = org_list;
        }
        var staff_list = A_searchArray["staff_cd"].replace('false',''); 
        if(staff_list){
            staff_list = ","+staff_list;
            data_select['staff'] = staff_list;
        }
        var prod_list = A_searchArray["prod_cd"].replace('false','');
        if(prod_list){
            prod_list = ","+prod_list;
            data_select['prod'] = prod_list;
        }        
    </script>
    <script type="text/javascript">
        function col_mgt(){
            if(mode_chk.checked){
                
               // $("#header_h  tr th:nth-child(1)").hide();
                $("#header_h  tr th:nth-child(4)").hide();
                $("#header_h  tr th:nth-child(5)").hide();
                $("#header_h  tr th:nth-child(14)").hide();
                $("#header_h  tr th:nth-child(15)").hide();
                $("#header_h  tr th:nth-child(16)").hide();
                $("#header_h  tr th:nth-child(17)").hide();
                $("#header_h  tr th:nth-child(18)").hide();
                        
               // $("#data tbody tr td:nth-child(1)").hide();
                $("#data tbody tr td:nth-child(4)").hide();
                $("#data tbody tr td:nth-child(5)").hide();
                $("#data tbody tr td:nth-child(14)").hide();
                $("#data tbody tr td:nth-child(15)").hide();
                $("#data tbody tr td:nth-child(16)").hide();
                $("#data tbody tr td:nth-child(17)").hide();
                $("#data tbody tr td:nth-child(18)").hide();   
                
                //$("#t_footer_data tbody td:nth-child(1)").hide();
                $("#t_footer_data tbody td:nth-child(4)").hide();
                $("#t_footer_data tbody td:nth-child(5)").hide();
                $("#t_footer_data tbody td:nth-child(14)").hide();
                $("#t_footer_data tbody td:nth-child(15)").hide();
                $("#t_footer_data tbody td:nth-child(16)").hide();
                $("#t_footer_data tbody td:nth-child(17)").hide();
                $("#t_footer_data tbody td:nth-child(18)").hide();               
            }else{
                $("#header_h  tr th:nth-child(6)").hide();
                $("#header_h  tr th:nth-child(8)").hide();
                $("#header_h  tr th:nth-child(10)").hide();
                $("#header_h  tr th:nth-child(11)").hide();
                $("#header_h  tr th:nth-child(13)").hide();
                        
                $("#data tbody tr td:nth-child(6)").hide(); 
                $("#data tbody tr td:nth-child(8)").hide();
                $("#data tbody tr td:nth-child(10)").hide();
                $("#data tbody tr td:nth-child(11)").hide();
                $("#data tbody tr td:nth-child(13)").hide();   
                
                $("#t_footer_data tbody td:nth-child(6)").hide(); 
                $("#t_footer_data tbody td:nth-child(8)").hide();
                $("#t_footer_data tbody td:nth-child(10)").hide();
                $("#t_footer_data tbody td:nth-child(11)").hide();
                $("#t_footer_data tbody td:nth-child(13)").hide();                 
                
            }
        }
        function radio_change_management(){
             var prev = [];
             document.getElementById("serchTable").addEventListener('change', function(e) {
                 //console.log('Previous:', prev[e.target.name] ? prev[e.target.name].value : null);
                 //console.log(e);
                 if(e.target.name === "period"){
                     if(!prev[e.target.name]){
                         old_id_start="start_date";
                         old_id_end="end_date";                              
                     }else if(prev[e.target.name].value === "day"){
                         old_id_start="start_date";
                         old_id_end="end_date";                            
                     }else if(prev[e.target.name].value === "month"){
                         old_id_start="start_dateM";
                         old_id_end="end_dateM";  
                     }else if(prev[e.target.name].value === "year"){
                         old_id_start="start_year";
                         old_id_end="end_year";
                     }
                     document.getElementById(old_id_start).hidden=true;
                     document.getElementById(old_id_end).hidden=true;
                     document.getElementById(old_id_start).value="";
                     document.getElementById(old_id_end).value="";                                                
                     if(e.target.value === "day"){
                         date_mode = "date";
                         new_id_start="start_date";
                         new_id_end="end_date"; 
                         // checkbox checked
                         today = new Date();
                         document.getElementById(new_id_end).value = today.toISOString().slice(0,10).replace(/-/g,"\/"); 
                         today.setMonth(today.getMonth()-1);
                         document.getElementById(new_id_start).value = today.toISOString().slice(0,10).replace(/-/g,"\/");                            
                     }else if(e.target.value === "month"){
                         date_mode = "dateM";
                         new_id_start="start_dateM";
                         new_id_end="end_dateM";
                         today = new Date();
                         document.getElementById(new_id_end).value = today.toISOString().slice(0,7).replace(/-/g,"\/"); 
                         today.setMonth(today.getMonth()-1);
                         document.getElementById(new_id_start).value = today.toISOString().slice(0,7).replace(/-/g,"\/");                                                        
                     }else if(e.target.value === "year"){
                         date_mode = "year";
                         new_id_start="start_year";
                         new_id_end="end_year";
                         today = new Date();
                         document.getElementById(new_id_end).value = today.toISOString().slice(0,4).replace(/-/g,"\/"); 
                         today.setFullYear(today.getFullYear()-1);
                         document.getElementById(new_id_start).value = today.toISOString().slice(0,4).replace(/-/g,"\/");                                                                                    
                     }         
                     document.getElementById(new_id_start).hidden=false;
                     document.getElementById(new_id_end).hidden=false;                        
                 }else if(e.target.name === "org_r"){
                     document.getElementById("tenpo").checked = false;
                     if(!prev[e.target.name]){
                         prev[e.target.name]={value:""};
                     }
                     document.getElementById("org_select").disabled=true;
                     if(e.target.value === "" ){
                         document.getElementById("org_select").disabled=false;
                     }else if(e.target.value === "compile"){
                         document.getElementById("tenpo").checked = true;
                     }  
                 }else if(e.target.name === "sect_r"){
                     if(!prev[e.target.name]){
                         prev[e.target.name]={value:""};
                     }                        
                     document.getElementById("sect_select").disabled=true;
                     if(e.target.value === "" ){
                         document.getElementById("sect_select").disabled=false;
                     }
                 }else if(e.target.name === "prod_r"){
                     if(!prev[e.target.name]){
                         prev[e.target.name]={value:""};
                     }                        
                     document.getElementById("prod_select").disabled=true;
                     if(e.target.value === "" ){
                         document.getElementById("prod_select").disabled=false;
                     }
                 }else if(e.target.name === "staff_r"){
                     if(!prev[e.target.name]){
                         prev[e.target.name]={value:""};
                     }                        
                     document.getElementById("staff_select").disabled=true;
                     if(e.target.value === "" ){
                         document.getElementById("staff_select").disabled=false;
                     }
                 }else if(e.target.name ==="mode_chk"){
                     search.click();
                 }
                 
                 prev[e.target.name] = e.target;
             });
         }                
        function chf(frm){
            
            if( 1 < window.location.search.length )
                {
                  // modal data
                    elem_str_date = document.getElementById("start_date").value.replace(/\//g,"");
                    elem_end_date = document.getElementById("end_date").value.replace(/\//g,"");
                    if(elem_str_date === ""){
                        alert("日付を入力してください。");
                        document.getElementById("start_date").focus();
                        return false;
                    }else if(elem_end_date === ""){
                        alert("日付を入力してください。");
                        document.getElementById("end_date").focus();
                        return false;
                    }
                    if(elem_str_date > elem_end_date){
                        alert("期間指定が不正です。開始日が終了日を超えています。");
                        document.getElementById("start_date").value="";
                        document.getElementById("start_date").focus();
                        return false;
                    } 					  
                    // org_id
                    csv_data.value = '';
                    if(org_r_selected.checked){
                        // list org name
                        for(i=0;i<org_select.options.length;i++){
                            if( !isNaN(org_select.options[i].value) ){
                                org_nm_lst.value = org_nm_lst.value + ','+org_select.options[i].innerText;
                            }
                            
                        }  
                        org_nm_lst.value = org_nm_lst.value.replace(/^,/,"");
                        org_id.value = org_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!org_list){
                            alert("店舗を選択してください。");
                            return false;
                        }
                    }else{
                        org_id.value = false;
                    }

                    // sect_cd                    
                    if(sect_r_selected.checked){
                        // list sect name
                        for(i=0;i<sect_select.options.length;i++){
                            if( !isNaN(sect_select.options[i].value) ){
                                sect_nm_lst.value = sect_nm_lst.value + ','+sect_select.options[i].innerText;
                            }
                            
                        } 
                        sect_nm_lst.value = sect_nm_lst.value.replace(/^,/,"");
                        sect_cd.value = sect_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!sect_list){
                            alert("部門を選択してください。");
                            return false;
                        }
                    }else{
                        sect_cd.value = false;
                    }
                     // prod_cd                    
                    if(prod_r_selected.checked){
                        // list prod name
                        for(i=0;i<prod_select.options.length;i++){
                            if( !isNaN(prod_select.options[i].value) ){
                                prod_nm_lst.value = prod_nm_lst.value + ','+prod_select.options[i].innerText;
                            }
                            
                        }
                        prod_nm_lst.value = prod_nm_lst.value.replace(/^,/,"");
                        prod_cd.value = prod_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!prod_list){
                            alert("商品を選択してください。");
                            return false;
                        }
                    }else{
                        prod_cd.value = false;
                    }
                    // staff_cd                    
                    if(staff_r_selected.checked){
                        // list staff name
                        for(i=0;i<staff_select.options.length;i++){
                            if( !isNaN(staff_select.options[i].value) ){
                                staff_nm_lst.value = staff_nm_lst.value + ','+staff_select.options[i].innerText;
                            }
                            staff_nm_lst.value = staff_nm_lst.value.replace(/^,/,"");
                        }   
                        staff_cd.value = staff_list.replace(/^,/,"'").replace(/,/g,"','").replace(/$/,"'");
                        if(!staff_list){
                            alert("担当者を選択してください。");
                            return false;
                        }
                    }else{
                        staff_cd.value = false;
                    }                                 
                    // 最初の1文字 (?記号) を除いた文字列を取得する
                    var query = window.location.search.substring( 1 );
                    var action = frm.action.split( '?' );

                    // 検索以外の機能実行後だった場合、パラメータを補正する
                    if(1 < action.length){
                        frm.action = action[0];
                    }

                    // クエリの区切り記号 (&) で文字列を配列に分割する
                    var parameters = query.split( '&' );

                    if (frm.onbtn.value == 'serch') {
                      frm.target='_self';
                        if(1 < parameters.length){
                             frm.action += '?param=' +frm.elements["codeName"].value + '&home=1';
                         }else{
                             frm.action += '?param=' +frm.elements["codeName"].value;
                        }
                    }else if (frm.onbtn.value == 'csvoutput'){
                        header_text = header_h.getElementsByTagName('tr')[0].innerText.replace(' ▲',"").replace(' ▼',"").replace(/\n/g,"").replace(/\t/g,",");
                        elem_tr_list = t_body_data.getElementsByTagName('tr');
                        data_send = [];
                        var csv_data_o = {};
                        csv_data_o['"0"'] = header_text;
                        var row_nb = 1;
                        for(i=0;i<elem_tr_list.length;i++){
                            csv_data_o['"'+row_nb+'"'] = '"'+elem_tr_list[i].innerText.replace(/\t/g,'","')+'"';
                            row_nb +=1;
                        } 
                        //console.log(csv_data_o);
                        csv_data.value = JSON.stringify(csv_data_o);                        
                        
                        if(1 < parameters.length){
                             frm.action += '?param=LedgerSheetBySalesStaffManagement/csvoutput&home=1';
                         }else{
                             frm.action += '?param=LedgerSheetBySalesStaffManagement/csvoutput';
                        }
                        //return false;
                    }
                }
       }

    /**
     *  イベント制御用
     *
     */
    function set_value(s_val){
        document.serchForm.onbtn.value = s_val;
    }

    /**
     * DatePickerを設定
     */
    $(function()
    {
        $( "#start_date, #end_date" ).datepicker({
            numberOfMonths: 2,
            showCurrentAtPos: 1,
            showButtonPanel: true,
            dateFormat: 'yy/mm/dd'
        });
    });

    /**
     *
     * スクロール制御
     *
     */
        function SyncScroll(/* elem1, elem2, ... */) {
            this._elements = [];
            this._elementOnscroll = this._elementOnscroll.bind(this);
            this.addElement.apply(this, arguments);
        }
        SyncScroll.prototype = {
            enableHorizontal: true,
            enableVertical: true,
            addElement: function (/* elem1, elem2, ... */) {
                var elem, i;
                for (i = 0; i < arguments.length; i += 1) {
                    elem = arguments[i];
                    elem.addEventListener('scroll', this._elementOnscroll, false);
                    this._elements.push(elem);
                }
            },
            removeElement: function (/* elem1, elem2, ... */) {
                var elem, i, j;
                for (i = 0; i < arguments.length; i += 1) {
                    elem = arguments[i];
                    elem.removeEventListener('scroll', this._elementOnscroll, false);
                    j = this._elements.indexOf(elem);
                    if (j >= 0) {
                        this._elements.splice(j, 1);
                    }
                }
            },
            _elementOnscroll: function (event) {
                var i,
                    elems = this._elements,
                    elem = event.target,
                    x = elem.scrollLeft,
                    y = elem.scrollTop;
                if (this.enableHorizontal) {
                    for (i = 0; i < elems.length; i += 1) {
                        elem = elems[i];
                        if (elem === event.target || elem.scrollLeft === x) {
                            continue;
                        }
                        elem.scrollLeft = x;
                        if (elem.scrollLeft !== x) {
                            elem.scrollLeft = x + x - elem.scrollLeft;
                        }
                    }
                }/*
                if (this.enableVertical) {
                    for (i = 0; i < elems.length; i += 1) {
                        elem = elems[i];
                        if (elem === event.target || elem.scrollTop === y) {
                            continue;
                        }
                        elem.scrollTop = y;
                        if (elem.scrollTop !== y) {
                            elem.scrollTop = y + y - elem.scrollTop;
                        }
                    }
                }*/
            },
            destroy: function () {
                this.removeElement.apply(this, this._elements);
            }
        };

        window.onload = function () {
            creat_listener();
           radio_change_management();
            // create select
            //var empty_array = [];
            csv_data.value = '';
            sect_array = [];
            if(A_param["sect_r"] === ""){
                code_list = sect_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["sect_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    sect_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("sect_select",sect_array);
            if(sect_list){
                sect_r_selected.checked = true;
                sect_select.disabled = false;
            }
            if(A_param["sect_select"] && A_param["sect_select"] !== 'empty'){
                sect_select.value = A_param["sect_select"];
            }
            
            prod_array = [];
            if(A_param["prod_r"] === ""){
                code_list = prod_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["prod_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    prod_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("prod_select",prod_array);
            if(prod_list){
                prod_r_selected.checked = true;
                prod_select.disabled = false;
            }
            if(A_param["prod_select"] && A_param["prod_select"] !== 'empty'){
                prod_select.value = A_param["prod_select"];
            }            
            
            org_array = [];
            if(A_param["org_r"] === ""){
                code_list = org_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["org_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    org_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("org_select",org_array);
            if(org_list){
                org_r_selected.checked = true;
                org_select.disabled = false;
            }
            if(A_param["org_select"] && A_param["org_select"] !== 'empty'){
                org_select.value = A_param["org_select"];
            }
            
            staff_array = [];
            if(A_param["staff_r"] === ""){
                code_list = staff_list.replace(/^,/,'').split(',').sort();
                name_list = A_param["staff_nm_lst"].split(',');
                for(i=0;i<name_list.length;i++){
                    staff_array[code_list[i]] = name_list[i];
                }          
            }
            modal_create_select("staff_select",staff_array);
            if(staff_list){
                staff_r_selected.checked = true;
                staff_select.disabled = false;
            }
            if(A_param["staff_select"] && A_param["staff_select"] !== 'empty'){
                staff_select.value = A_param["staff_select"];
            }
            if(A_searchArray['mode_chk']){
                mode_chk.checked = true;
            }
            sort.value = A_searchArray['sort'];
            asc_desc   = sort.value.split('#')[1];
            if(Number(asc_desc) === 1){
                window['id_'+sort.value.split('#')[0]].innerText += ' ▲' 
            }else{
                window['id_'+sort.value.split('#')[0]].innerText += ' ▼' 
            }            
            col_mgt();
            // 縦方向のみ
            var sample2_1 = document.getElementById('header_h');
            var sample2_2 = document.getElementById('data');
            var sample2_3 = document.getElementById('footer_h'); 
            var syncScroll2 = new SyncScroll(sample2_1, sample2_3, sample2_2);
            syncScroll2.enableHorizontal = true;

            // 横方向のみ
            var sample3_1 = document.getElementById('header_h');
            var sample3_2 = document.getElementById('data');
            var sample3_3 = document.getElementById('footer_h');            
            var syncScroll3 = new SyncScroll(sample3_1, sample3_3, sample3_2);
            syncScroll3.enableVertical = false;
        };
        function sort_tbody(col_sort){
            console.log(col_sort + ' // ' + sort.value);
            if(sort.value.indexOf(col_sort) !== -1){
                asc_desc = -1*asc_desc;
            }else{
                asc_desc = 1;
            }
            sort.value = col_sort + '#'+asc_desc;  
            search.click();           
        }        

        /**
        * ソート処理
        */
        function setColumnInfo(thisItemInfo)
        {
            listItemInfo = thisItemInfo;

            listSort = 0;
            var sortVal = document.getElementById('sort').value;

            if(listItemInfo === "1")
            {
                // 店舗
                if((sortVal % 2) == 0)
                {
                    listSort = 1;
                }
                else
                {
                    listSort = 2;
                }
            }
            else if(listItemInfo === "2")
            {
                // 商品コード
                if((sortVal % 2) == 0)
                {
                    listSort = 3;
                }
                else
                {
                    listSort = 4;
                }
            }
            else if(listItemInfo === "3")
            {
                // 商品名
                if((sortVal % 2) == 0)
                {
                    listSort = 5;
                }
                else
                {
                    listSort = 6;
                }
            }
            else if(listItemInfo === "4")
            {
                // 部門コード
                if((sortVal % 2) == 0)
                {
                    listSort = 7;
                }
                else
                {
                    listSort = 8;
                }
            }
            else if(listItemInfo === "5")
            {
                // 部門
                if((sortVal % 2) == 0)
                {
                    listSort = 9;
                }
                else
                {
                    listSort = 10;
                }
            }
            else if(listItemInfo === "6")
            {
                // 仕入先コード
                if((sortVal % 2) == 0)
                {
                    listSort = 11;
                }
                else
                {
                    listSort = 12;
                }
            }
            else if(listItemInfo === "7")
            {
                // 仕入先
                if((sortVal % 2) == 0)
                {
                    listSort = 13;
                }
                else
                {
                    listSort = 14;
                }
            }
            else if(listItemInfo === "8")
            {
                // 担当者コード
                if((sortVal % 2) == 0)
                {
                    listSort = 15;
                }
                else
                {
                    listSort = 16;
                }
            }
            else if(listItemInfo === "9")
            {
                // 担当者
                if((sortVal % 2) == 0)
                {
                    listSort = 17;
                }
                else
                {
                    listSort = 18;
                }
            }
            else if(listItemInfo === "10")
            {
                // 数量
                if((sortVal % 2) == 0)
                {
                    listSort = 19;
                }
                else
                {
                    listSort = 20;
                }
            }
            else if(listItemInfo === "11")
            {
                // 売上金額
                if((sortVal % 2) == 0)
                {
                    listSort = 21;
                }
                else
                {
                    listSort = 22;
                }
            }
            else if(listItemInfo === "12")
            {
                // 粗利額
                if((sortVal % 2) == 0)
                {
                    listSort = 23;
                }
                else
                {
                    listSort = 24;
                }
            }
            else if(listItemInfo === "13")
            {
                // 税抜売上金額
                if((sortVal % 2) == 0)
                {
                    listSort = 25;
                }
                else
                {
                    listSort = 26;
                }
            }

            // ソート情報を設定
            document.getElementById('sort').value = listSort;

            var frm = document.serchForm;

            // 最初の1文字 (?記号) を除いた文字列を取得する
            var query = window.location.search.substring( 1 );
            var action = frm.action.split( '?' );

            // 検索以外の機能実行後だった場合、パラメータを補正する
            if(1 < action.length){
            frm.action = action[0];
            }

            // クエリの区切り記号 (&) で文字列を配列に分割する
            var parameters = query.split( '&' );

            frm.target='_self';
            if(1 < parameters.length){
                frm.action += '?param=' +frm.elements["codeName"].value + '&home=1';
            }else{
                frm.action += '?param=' +frm.elements["codeName"].value;
            }
            frm.submit();
        }
    </script>

    <STYLE type="text/css">
        .serchListArea tr:nth-child(even) td { background: transparent; }
        /*テーブルの幅と位置移動 2019/12/04 柴田*/
        #search_param{
           overflow: hidden;
           max-width: 1070px;
           margin-left: auto !important;
           margin-right: auto !important;
        }
        #header_h,#footer_h {
           width:98%;
           max-height:32px;
           overflow-x:hidden;overflow-y:hidden;
           }
        #header_v {
           width:90px;max-height:600px;
           overflow-x:scroll;overflow-y:hidden;
           text-align: left;
           }
        #data {
           width:99%;max-height: 550px;
           overflow-x:scroll;overflow-y:scroll;
           table-layout: fixed;
           }
           #search_param th{
            width:80px
           }
            #search_param td{
            width:200px
           }
           
        #header_h th:nth-child(1),
        #data td:nth-child(1),
        #footer_h td:nth-child(1),
        #header_h th:nth-child(3),
        #data td:nth-child(3),
        #footer_h td:nth-child(3),
        #header_h th:nth-child(16),
        #data td:nth-child(16),
        #footer_h td:nth-child(16){
            width: 120px;
        }
        
        #header_h th:nth-child(2),
        #data td:nth-child(2),
        #footer_h td:nth-child(2),
        #header_h th:nth-child(6),
        #data td:nth-child(6),
        #footer_h td:nth-child(6),
        #header_h th:nth-child(7),
        #data td:nth-child(7),
        #footer_h td:nth-child(7),
        #header_h th:nth-child(10),
        #data td:nth-child(10),
        #footer_h td:nth-child(10),
        #header_h th:nth-child(13),
        #data td:nth-child(13),
        #footer_h td:nth-child(13),        
        #header_h th:nth-child(15),
        #data td:nth-child(15),
        #footer_h td:nth-child(15),
        #header_h th:nth-child(17),
        #data td:nth-child(17),
        #footer_h td:nth-child(17){
            width: 65px;
        }
        
        #header_h th:nth-child(5),
        #data td:nth-child(5),
        #footer_h td:nth-child(5),
        #header_h th:nth-child(18),
        #data td:nth-child(18),
        #footer_h td:nth-child(18){
            width: 230px;
        }
        
        #header_h th:nth-child(4),
        #data td:nth-child(4),
        #footer_h td:nth-child(4),
        #header_h th:nth-child(8),
        #data td:nth-child(8),
        #footer_h td:nth-child(8),
        #header_h th:nth-child(9),
        #data td:nth-child(9),
        #footer_h td:nth-child(9),
        #header_h th:nth-child(11),
        #data td:nth-child(11),
        #footer_h td:nth-child(11),
        #header_h th:nth-child(12),
        #data td:nth-child(12),
        #footer_h td:nth-child(12),
        #header_h th:nth-child(14),
        #data td:nth-child(14),
        #footer_h td:nth-child(14){      
            width: 110px;
        }
        #data td, #footer_h td{
            text-align: left;
        }
        #data td:nth-child(6),
        #footer_h td:nth-child(6),
        #data td:nth-child(7),
        #footer_h td:nth-child(7),
        #data td:nth-child(8),
        #footer_h td:nth-child(8),
        #data td:nth-child(9),
        #footer_h td:nth-child(9),
        #data td:nth-child(10),
        #footer_h td:nth-child(10),
        #data td:nth-child(11),
        #footer_h td:nth-child(11),
        #data td:nth-child(12),
        #footer_h td:nth-child(12),
        #data td:nth-child(13),
        #footer_h td:nth-child(13),
        #data td:nth-child(14),
        #footer_h td:nth-child(14){
            text-align: right;
        }  
        .chk {
            vertical-align: text-bottom;
        }
        select{
            max-width: 120px;
        }
    </STYLE>

    </head>
    <body>
<?php
if( isset($_GET['home']) ) {
    if( "1" ==  $_GET['home'] ){
        include("../home/View/Common/PageHeader.php");
    }else{
        include("Common/PageHeader.php");
    }
}else{
        include("Common/PageHeader.php");
}
?>

<!-- Site -->
<div id="sb-site">
<form name="serchForm" id="serchForm" action="/profit/index.php" method="post" onsubmit="return chf(this)">
<div class="serchListArea">
<!--追加項目　search_param　2019/12/04　柴田-->
    <div id="search_param">
        <div class="serchListArea" id="search_param" >
            <table align="center">
                <tr>
                    <td>
                        <table id="serchTable">
                            <tr>
                                <th id="serchTableTitle" align="left" width="65">
                                    帳票
                                </th>
                                <td id="serchTableItem" align="left" width="200">
                                    担当者別売上管理表
                                    <input type="hidden" name="codeName" id="codeName" value="LedgerSheetBySalesStaffManagement/show">
                                </td>
                                <th id="serchTableTitle" align="left" width="65">
                                    期間<br />指定
                                    <!--文字修正　2019/12/01　柴田-->
                                </th>
                                <td id="serchTableItem" width="200">
                                    <input type="text" pattern="\d{4}/\d{2}/\d{2}" title="西暦/月の形式で入力してください。" id="start_date" name="start_date" size="10" value=<?php hsc($startDate); ?>>
                                    <input type="text" pattern="\d{4}/\d{2}/\d{2}" title="西暦/月の形式で入力してください。" id="end_date" name="end_date" size="10" value=<?php hsc($endDate); ?>>
                                </td>
                                <th id="serchTableTitle" align="left" width="65">
                                    商品<br />選択
                                </th>
                                <td id="serchTableItem" width="200">
                                    <input type="radio" name="prod_r" id="prod_r_all" value="all" checked> 全商品<br />
                                    <input type="radio" name="prod_r" id="prod_r_selected" value=""> 商品指定&nbsp;&nbsp;
                                    <select id="prod_select" name="prod_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>                        
                                    <input type="text" name="prod_cd" value="" id="prod_cd" hidden>
                                    <input type="text" name="prod_nm_lst" value="" id="prod_nm_lst" hidden> 
                                </td>
                                <td align="center" colspan="2" width="100">
                                    <input class="submit" type="submit" name="search" id="search" value="検索" onClick="set_value('serch')">
                                    <input type="text" name="csv_data" value="" id="csv_data" hidden>
                                    <?php if( !empty($ledgerSheetDetailList) ) { ;?>
                                        <input width=20 size=10 class="submit" type="submit" name="csvoutput" id="csvoutput" value="CSV出力" onClick="set_value('csvoutput')">
                                    <?php } ?>
                                  <input type="hidden" name="onbtn">
                                </td>                    
                            </tr>

                            <tr class=shita> 
                                <th id="serchTableTitle" align="left" width="90">
                                    担当者<br />選択
                                </th>
                                <td id="serchTableItem" width="200">
                                    <input type="radio" name="staff_r" id="staff_r_all" value="all" checked> 全担当者<br />
                                    <input type="radio" name="staff_r" id="staff_r_selected" value=""> 担当者指定&nbsp;&nbsp;
                                    <select id="staff_select" name="staff_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>                        
                                    <input type="text" name="staff_cd" value="" id="staff_cd" hidden>
                                    <input type="text" name="staff_nm_lst" value="" id="staff_nm_lst" hidden>   
                                </td>
                                <th id="serchTableTitle" align="left" width="65">
                                    店舗<br />選択
                                </th>
                                <td align="left" width=110>
                                    <input type="radio" name="org_r" id="org_r_all" value="all" checked> 全店<br />
                                    <input type="radio" name="org_r" id="org_r_selected" value=""> 店舗指定&nbsp;&nbsp;
                                    <select id="org_select" name="org_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                                    <input type="checkbox" name="tenpo" value="Yes" id="tenpo" hidden>
                                    <input type="text" name="org_id" value="" id="org_id" hidden>
                                    <input type="text" name="org_nm_lst" value="" id="org_nm_lst" hidden> 
                                </td>                    
                                <th id="serchTableTitle" align="left" width="90">
                                    部門<br />選択
                                </th>
                                <td id="serchTableItem" width="200">
                                    <input type="radio" name="sect_r" id="sect_r_all" value="all" checked> 全部門<br />
                                    <input type="radio" name="sect_r" id="sect_r_selected" value=""> 部門指定&nbsp;&nbsp;
                                    <select id="sect_select" name="sect_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>                        
                                    <input type="text" name="sect_cd" value="" id="sect_cd" hidden>
                                    <input type="text" name="sect_nm_lst" value="" id="sect_nm_lst" hidden> 
                                </td>
                                <td align="center" colspan="2"><input type="checkbox" name="mode_chk" value="Yes" id="mode_chk" class="chk"> 担当者別売上管理表</td>
                            </tr>
                        </table>
                        <!-- The Modal -->
                        <div id="modal_sect" class="modal">
                            <!-- Modal content -->
                            <div class="modal-content">
                                <?php include("../modal/View/Modaldepartment.html"); ?>
                            </div>
                        </div>
                        <div id="modal_prod" class="modal">
                            <!-- Modal content -->
                            <div class="modal-content">
                                <?php include("../modal/View/Modalproduct.html"); ?>
                            </div>
                        </div>             
                        <div id="modal_org" class="modal">
                            <!-- Modal content -->
                            <div class="modal-content">
                                <?php include("../modal/View/Modalorganization.html"); ?>
                            </div>
                        </div>  
                        <div id="modal_staff" class="modal">
                            <!-- Modal content -->
                            <div class="modal-content">
                                <?php include("../modal/View/Modalstaff.html"); ?>
                            </div>
                        </div>               
                    </td>
                </tr>
            </table>
        </div>
    </div>

<!-- 固定ヘッダ -->
<table>
    <tr>
        <td>
            <!-- 水平ヘッダ -->
            <div id="header_h">
                <table>
                    <tr>
                       <th onclick="sort_tbody('organization_name')" id="id_organization_name"><u>店舗</u></th>
                       <th onclick="sort_tbody('staff_cd')" id="id_staff_cd"><u>担当者<br />コード</u></th>
                       <th onclick="sort_tbody('staff_nm')" id="id_staff_nm"><u>担当者名</u></th>
                       <th onclick="sort_tbody('prod_cd')" id="id_prod_cd"><u>商品<br />コード</u></th>
                       <th onclick="sort_tbody('prod_nm')" id="id_prod_nm"><u>商品名</u></th>
                       <th onclick="sort_tbody('cust_amount')" id="id_cust_amount"><u>客数</u></th>
                       <th onclick="sort_tbody('amount')" id="id_amount"><u>数量</u></th>
                       <th onclick="sort_tbody('sale_average')" id="id_sale_average"><u>平均売上単価</u></th>
                       <th onclick="sort_tbody('pure_total')" id="id_pure_total"><u>売上金額</u></th>
                       <th onclick="sort_tbody('day_costprice')" id="id_day_costprice"><u>原価</u></th>
                       <th onclick="sort_tbody('profit_average')" id="id_profit_average"><u>平均粗利<br />単価</u></th>
                       <th onclick="sort_tbody('profit_i')" id="id_profit_i"><u>粗利額</u></th>
                       <th onclick="sort_tbody('profit_margin')" id="id_profit_margin"><u>粗利率</u></th>
                       <th onclick="sort_tbody('pure_total_i')" id="id_pure_total_i"><u>税抜売上金額</u></th>
                       <th onclick="sort_tbody('sect_cd')" id="id_sect_cd"><u>部門<br />コード</u></th>
                       <th onclick="sort_tbody('sect_nm')" id="id_sect_nm"><u>部門名</u></th>
                       <th onclick="sort_tbody('supp_cd')" id="id_supp_cd"><u>仕入先<br />コード</u></th>
                       <th onclick="sort_tbody('supp_nm')" id="id_supp_nm"><u>仕入先名</u></th>              

                    </tr>
                </table>
                <input type="hidden" id="sort" name="sort" >
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <!-- データ部分  -->
            <div id="data">
            <table id="t_body_data">
                <?php  
                    $prev_org_nm = '';
                    $prev_staff_nm = '';
                    
                if( !empty($ledgerSheetDetailList) ) {                 
                    foreach ($ledgerSheetDetailList as $rows ) { 
                        if($prev_org_nm !== $rows['organization_name']){
                            $prev_staff_nm = '';
                        }
                ?>
                <tr>
                    <td><?php if($prev_org_nm !== $rows['organization_name']){hsc($rows['organization_name']);}?></td>
                    <td><?php if($prev_staff_nm !== $rows['staff_nm']){hsc($rows['staff_cd']);}?></td>
                    <td><?php if($prev_staff_nm !== $rows['staff_nm']){hsc($rows['staff_nm']);}?></td>
                    <?php
                    if(!empty($rows['prod_nm'])) {?>
                    <td><?php hsc($rows['prod_cd']);?></td>
                    <?php }else{ ?>
                        <td><?php hsc($rows['sect_cd']);?></td>
                    <?php }?>
                    <?php
                    if(!empty($rows['prod_nm'])) {?>
                    <td><?php hsc($rows['prod_nm']);?></td>
                    <?php }else{ ?>
                        <td><?php hsc($rows['sect_nm']);?></td>
                    <?php }?>
                    <td><?php hsc(number_format($rows['cust_amount']),0);?></td>
                    <td><?php hsc(number_format($rows['amount']),0);?></td>
                    <td><?php hsc(number_format($rows['sale_average']),0);?></td>
                    <td><?php hsc(number_format($rows['pure_total'],0));?></td>
                    <td><?php hsc(number_format($rows['day_costprice']),0);?></td>
                    <td><?php hsc(number_format($rows['profit_average']),0);?></td>
                    <td><?php hsc(number_format($rows['profit_i'],0));?></td>
                    <td><?php hsc(number_format($rows['profit_margin'],2));?></td>
                    <td><?php hsc(number_format($rows['pure_total_i'],0));?></td>
                    <td><?php hsc($rows['sect_cd']);?></td>
                    <td><?php hsc($rows['sect_nm']);?></td>
                    <td><?php hsc($rows['supp_cd']);?></td>
                    <td><?php hsc($rows['supp_nm']);?></td>
                </tr>
                    <?php
                        $prev_org_nm = $rows['organization_name'];
                        $prev_staff_nm = $rows['staff_nm'];
                    } ?>
                <?php } ?>
            </table>
            </div>
        </td>
    </tr>
<?php if( !empty($ledgerSheetDetailList) ) { ?>   
    <tr>
        <td>        
            <div id='sep'>
                <table style="table-layout:fixed;">
                    <tr>
                        <th></th>
                    </tr>
                </table>
            </div> 
        </td>    
    </tr>    
    <tr>
        <td>
            <div id="footer_h">
                <table id="t_footer_data" style="table-layout:fixed;">
                    <tr>
                        <td></td>
                        <td></td>
                        <td>総合計</td>
                        <td></td>
                        <td></td>
                        <td><?php hsc(number_format($sumLine['cust_amount']),0);?></td>
                        <td><?php hsc(number_format($sumLine['amount']),0);?></td>
                        <td><?php
                           if($sumLine['amount']==0){echo "0";}else{ hsc(number_format($sumLine['pure_total']/$sumLine['amount']),0);}
                        ?></td>
                        <td><?php hsc(number_format($sumLine['pure_total'],0));?></td>
                        <td><?php hsc(number_format($sumLine['day_costprice']),0);?></td>
                        <td><?php
                            if($sumLine['amount']==0){echo "0";}else{hsc(number_format($sumLine['profit_i']/$sumLine['amount']),0);}
                        ?></td>
                        <td><?php hsc(number_format($sumLine['profit_i'],0));?></td>
                        <td><?php
                            if($sumLine['pure_total']==0){echo "0.00";}else{hsc(number_format($sumLine['profit_i']/$sumLine['pure_total']*100,2));}
                        ?></td>
                        <td><?php hsc(number_format($sumLine['pure_total_i'],0));?></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>                    
                </table>
            </div>
        </td>
    </tr>   
<?php } ?>
</table>
</div>
</form>
<!--<script type="text/javascript" src="../jquery/js/scrolltopcontrol2.js"></script>
スクロールしながらページのトップに戻る-->
</div><!-- /#sb-site -->

</body>
</html>
