<?php
    /**
     * @file      商品別実績画面(View)
     * @author    millionet montagne
     * @date      2019/05/22
     * @version   1.00
     * @note      
     */
?>
<!DOCTYPE html>
<html>
    <head>
        <?php
            $fileNames = array('default.css'); // cssまたはｊｓファイルを拡張子付きで配列に記述
            include("../profit/View/Common/HtmlHeader.php");
        ?>

        <script src="../js/profit/jquery/jquery.ui.ympicker.js" ></script>
        <script src="../js/profit/jquery/jquery-migrate-1.0.0.js" ></script>
        <script src="../js/profit/jquery/datepicker-ja.js" ></script>
        <script src="../js/autofil_v<?php echo $_SESSION['AUTOFIL_VER'] ?>.js" ></script>
        <!-- modal script-->
        <script src="../js/modal/modal.js" ></script>
        <link rel="stylesheet" href="../css/modal/modal.css" >
        

        <script type="text/javascript">
            Sizelist       = '<?php echo json_encode(json_encode($Sizelist)); ?>';
            A_Sizelist     = JSON.parse(Sizelist.slice(1,-1)); 
            asc            = [];
	    nb_row_shown        = [];		
            porg_id_list        = '<?php echo json_encode(json_encode($org_id_list)); ?>';
            data_org            = JSON.parse(porg_id_list.slice(1,-1)); 
            ptypsect_detail     = '<?php echo json_encode($sect_detail); ?>';
            data_sect           = JSON.parse(ptypsect_detail);
            ptypsupp_detail     = '<?php echo json_encode($supp_detail); ?>';
            data_supp           = JSON.parse(ptypsupp_detail);
            lst_spe_sales       = '<?php echo json_encode($spe_sales_lst); ?>';
            A_lst_spe_sales     = JSON.parse(lst_spe_sales);
            spe_sales_detail    = '<?php echo json_encode($spe_sales_detail); ?>';
            A_spe_sales_detail  = JSON.parse(spe_sales_detail);	

			
            var date_mode = "date";
            var sect_list = "";
            var org_list = "";
            var prod_list = "";
            var supp_list = "";
            
            function numberWithCommas(x,precision = 0) {
                // x : value
                // precision : precision to return default 0 (no decimal: 99) | 1 => 99.9 | 2 => 99.99 ...
                x = Math.round(Number(x)*Math.pow(10,precision))/Math.pow(10,precision);
                var parts = x.toString().split(".");
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                if(precision){
                    if(!parts[1]){
                        parts[1] = 0;
                    }                    
                    parts[1]=(parts[1]+"0".repeat(precision)).substr(0,precision);
                }                
                return parts.join(".");
            }
            
            /**
             * DatePickerを設定
             */
            $(function()
            {
                $( "#start_date, #end_date" ).datepicker({
                    numberOfMonths: 2,
                    showCurrentAtPos: 1,
                    showButtonPanel: true,
                    dateFormat: 'yy/mm/dd'
                });
            });

            $(function() {
                $("#start_dateM").ympicker({
                    altField: "#start_dateM" //リターンセットUI IDorCLASS名
                    ,altFormat: "yy/mm" //リターン日付形式
                    ,monthNamesShort: ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]  //カレンダー表示月形式
                    ,showAnim: "slideDown" //表示アニメーション形式
                    ,yearRange: "c-2:c+3" //プルダウン年範囲
                });
            });
            $(function() {
                $("#end_dateM").ympicker({
                    altField: "#end_dateM" //リターンセットUI IDorCLASS名
                    ,altFormat: "yy/mm" //リターン日付形式
                    ,monthNamesShort: ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]  //カレンダー表示月形式
                    ,showAnim: "slideDown" //表示アニメーション形式
                    ,yearRange: "c-2:c+3" //プルダウン年範囲
                });
            });
            $(function() {
                $("#end_year, #start_year").datepicker({
                    dateFormat: "yy",
                    changeYear: true
                    ,changeMonth: false
                    ,showButtonPanel: false
                    ,onClose: function(dateText, inst) { 
                        var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                        $(this).datepicker('setDate', new Date(year, 1));
                    }
                }).focus(function(){
                    document.getElementsByClassName("ui-datepicker-calendar")[0].style.display="none";
                    document.getElementsByClassName("ui-datepicker-month")[0].style.display="none";
                    document.getElementsByClassName("ui-datepicker-prev")[0].style.display="none";
                    document.getElementsByClassName("ui-datepicker-next")[0].style.display="none";
                } )                ;
            });
            function radio_change_management(){
                var prev = [];
                document.getElementById("search_param").addEventListener('change', function(e) {
                    //console.log('Previous:', prev[e.target.name] ? prev[e.target.name].value : null);
                    //console.log(e);
                    if(e.target.name === "period"){
                        if(!prev[e.target.name]){
                            old_id_start="start_date";
                            old_id_end="end_date";                              
                        }else if(prev[e.target.name].value === "day"){
                            old_id_start="start_date";
                            old_id_end="end_date";                            
                        }else if(prev[e.target.name].value === "month"){
                            old_id_start="start_dateM";
                            old_id_end="end_dateM";  
                        }else if(prev[e.target.name].value === "year"){
                            old_id_start="start_year";
                            old_id_end="end_year";
                        }
                        document.getElementById(old_id_start).hidden=true;
                        document.getElementById(old_id_end).hidden=true;
                        document.getElementById(old_id_start).value="";
                        document.getElementById(old_id_end).value="";                                                
                        if(e.target.value === "day"){
                            date_mode = "date";
                            new_id_start="start_date";
                            new_id_end="end_date"; 
                            // checkbox checked
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,10).replace(/-/g,"\/"); 
                            today.setMonth(today.getMonth()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,10).replace(/-/g,"\/");                            
                        }else if(e.target.value === "month"){
                            date_mode = "dateM";
                            new_id_start="start_dateM";
                            new_id_end="end_dateM";
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,7).replace(/-/g,"\/"); 
                            today.setMonth(today.getMonth()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,7).replace(/-/g,"\/");                                                        
                        }else if(e.target.value === "year"){
                            date_mode = "year";
                            new_id_start="start_year";
                            new_id_end="end_year";
                            today = new Date();
                            document.getElementById(new_id_end).value = today.toISOString().slice(0,4).replace(/-/g,"\/"); 
                            today.setFullYear(today.getFullYear()-1);
                            document.getElementById(new_id_start).value = today.toISOString().slice(0,4).replace(/-/g,"\/");                                                                                    
                        }         
                        document.getElementById(new_id_start).hidden=false;
                        document.getElementById(new_id_end).hidden=false;                        
                    }else if(e.target.name === "org_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }
                        document.getElementById("org_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("org_select").disabled=false;
                        }  
                    }else if(e.target.name === "sect_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }                        
                        document.getElementById("sect_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("sect_select").disabled=false;
                        }
                    }else if(e.target.name === "prod_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }                        
                        document.getElementById("prod_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("prod_select").disabled=false;
                        }
                    }else if(e.target.name === "supp_r"){
                        if(!prev[e.target.name]){
                            prev[e.target.name]={value:""};
                        }                        
                        document.getElementById("supp_select").disabled=true;
                        if(e.target.value === "" ){
                            document.getElementById("supp_select").disabled=false;
                        }
                    }
                    prev[e.target.name] = e.target;
                });
            }
            function csv_print(e){
                elem_tr_list = table_body.getElementsByTagName("tr");
                data_send = [];
                var csv_data_o = {};
                var row_nb = 0;
                csv_data_o['"'+row_nb+'"'] =table_head.getElementsByTagName('tr')[0].innerText.replace(' ▲',"").replace(' ▼',"").replace(/[\n,\r]/g,'').replace(/\t/g,",");
                for(i=0;i<elem_tr_list.length;i++){
                    looprow = elem_tr_list[i];
                    if( looprow.childElementCount ===1 ){
                        continue;
                    }
                    if(looprow.style.backgroundColor){
                        //console.log(elem_tr_list[i]);
                        continue;
                    } 
                    row_nb += 1; 
                    csv_data_o['"'+row_nb+'"'] = '"'+looprow.innerText.replace(/\t/g,'","')+'"';
                }
                data_send["csv_data"] = JSON.stringify(csv_data_o);
                console.log(data_send);
				//return false;
                //data_sendを送ります。
                spath       = 'index.php?param=LedgerSheetProductResults/csvoutput';
               //console.log(spath);
                setDataForAjax( data_send, spath ,'ajaxScreenUpdate' );                
            }
           
            function sort_data(data_to_sort,sort_type, v_sort_data){
                // sort_type:  1 : asc
                //            -1 : desc
                function compare( a, b ) {
                    bcheck = "";
                    acheck = "";
                    //console.log(b);
                    //console.log(a);
                    if(b[v_sort_data] && !isNaN(b[v_sort_data])){
                        varsplit = b[v_sort_data].toString().split('.');
                        bcheck = varsplit[0];
                        if(varsplit[1]){
                            bcheck = bcheck + '.' + (varsplit[1]+"00").substr(0,2);
                        }else{
                            bcheck = bcheck + '.' + "00";
                        }
                        bcheck = ("0".repeat(51) + bcheck).slice(-51);
                    }else if( b[v_sort_data] ) {
                        bcheck = b[v_sort_data].toString().toLocaleLowerCase();
                    }
                    if(a[v_sort_data] && !isNaN(a[v_sort_data])){
                        varsplit = a[v_sort_data].toString().split('.');
                        acheck = varsplit[0];
                        if(varsplit[1]){
                            acheck = acheck + '.'+ (varsplit[1]+"00").substr(0,2);
                        }else{
                            acheck = acheck + '.' + "00";
                        }
                        acheck = ("0".repeat(51) + acheck).slice(-51);
                    }else if( a[v_sort_data] ){
                        acheck = a[v_sort_data].toString().toLocaleLowerCase();
                    }                            
                    //console.log("a.org_id: "+ a["org_id"] + " a.prod_cd: " +a["prod_cd"]+ " " + acheck + " a/b " +  bcheck+" b.org_id: "+ b["org_id"] + " b.prod_cd: " +b["prod_cd"]);
                    if ( acheck < bcheck ){
                      return -1;
                    }
                    if ( acheck > bcheck ){
                      return 1;
                    }
                    return 0;
                }                 
                //test = data_to_sort;
                A_v_sort_data = [];
                if( v_sort_data === "org_id" ){
                    A_v_sort_data = data_to_sort ;
                }else if( v_sort_data === "prod_cd" ){
                    //console.log("here");
                    org_key =  Object.keys(data_to_sort);
                    for(i=0;i<org_key.length;i++){
                        if(!A_v_sort_data[org_key[i]]){
                            A_v_sort_data[org_key[i]] = [];
                        }
                        loop_row = data_to_sort[org_key[i]];
                        sort_key = Object.keys(loop_row).sort();
                        if( sort_type === -1 ){
                            sort_key.reverse();
                        }
                        for(j=0;j<sort_key.length;j++){
                            A_v_sort_data[org_key[i]][sort_key[j]] = data_to_sort[org_key[i]][sort_key[j]];
                        }                      
                    }
                }else{
                    temp_data = [];
                    org_key =  Object.keys(data_to_sort);
                    for(i=0;i<org_key.length;i++){
                        loop_org_id = org_key[i];
                        if(!temp_data[loop_org_id]){
                            temp_data[loop_org_id] = [];
                        }                        
                        prod_key = Object.keys(data_to_sort[loop_org_id]);
                        A_v_sort_data[loop_org_id] = [];
                        for(j=0; j<prod_key.length ;j++){
                            loop_prod_cd = prod_key[j];
                            //console.log(data_to_sort[loop_org_id][prod_key[j]]);
                            special_key = Object.keys(data_to_sort[loop_org_id][loop_prod_cd]);
                            //console.log("special_key: "+special_key);
                            for(k=0;k<special_key.length;k++){
                                loop_special = special_key[k];
                                //console.log("i: "+i+" j: "+j+" k: "+k);
                                //console.log("loop_org_id: "+loop_org_id+" loop_prod_cd: "+loop_prod_cd+" loop_special: "+loop_special);
                                loop_row = data_to_sort[loop_org_id][loop_prod_cd][loop_special];
                                //console.log(loop_row);
                                temp_data[loop_org_id][temp_data[loop_org_id].length] = loop_row;
                                //console.log(temp_data[loop_org_id]);
                            }
                        }
                        temp_data[loop_org_id].sort( compare );
                        //temp_data[loop_org_id].sort((a, b) => (a[v_sort_data] > b[v_sort_data]) ? 1 : (a[v_sort_data] === b[v_sort_data]) ? ((a[v_sort_data] > b[v_sort_data]) ? 1 : -1) : -1 );
                        if( sort_type === -1 ){
                            temp_data[loop_org_id].reverse();
                        }
                        
                        // prepare data to return
                        for(jp=0;jp<temp_data[loop_org_id].length;jp++){
                             loop_row = temp_data[loop_org_id][jp];
                             //console.log(loop_row);
                             if(!A_v_sort_data[loop_org_id][(loop_row["prod_cd"]+"_"+jp).toString()]){
                                 A_v_sort_data[loop_org_id][(loop_row["prod_cd"]+"_"+jp).toString()] = [];
                             }
                             A_v_sort_data[loop_org_id][(loop_row["prod_cd"]+"_"+jp).toString()][loop_row["special"]] = loop_row;
                         }                        
                    }
                }
                return A_v_sort_data; 
            }            
            function search_data(){
                
                //clear sort
                asc=[];
                elem_table_id = document.getElementById("table_id");
                elem_thead = elem_table_id.getElementsByTagName('THEAD')[0];
                elem_th = elem_thead.getElementsByTagName('TH');
                for(i=0;i<elem_th.length;i++){
                    elem_th[i].innerHTML = elem_th[i].innerHTML.replace(' ▲',"").replace(' ▼',"");
                }
                nb_row_shown        = [];
                
                date_str_id = "start_"+date_mode;
                date_end_id = "end_"+date_mode;
                loop_sect_cd="";
                loop_date="";
                loop_org_id="";
                period_val = document.querySelector('input[name="period"]:checked').value;
                elem_str_date = document.getElementById(date_str_id).value.replace(/\//g,"");
                elem_end_date = document.getElementById(date_end_id).value.replace(/\//g,"");
                elem_special_sale = document.getElementById("special_sale");
                org_select_val = document.getElementById("org_select").value;
                sect_select_val = document.getElementById("sect_select").value;
                prod_select_val = document.getElementById("prod_select").value;
                supp_select_val = document.getElementById("supp_select").value;
                //console.log("here:"+elem_str_date.value+":");
                if(elem_str_date === ""){
                    alert("営業期間を入力してください。");
                    document.getElementById(date_str_id).focus();
                    return;                    
                }else if(elem_end_date === ""){
                    alert("営業期間を入力してください。");
                    document.getElementById(date_end_id).focus();
                    return;
                }
                if(elem_str_date > elem_end_date){
                    alert("期間指定が不正です。開始日が終了日を超えています。");
                    document.getElementById(date_str_id).value="";
                    document.getElementById(date_str_id).focus();
                    return;
                }
                if(period_val === "month"){
                    temp_data = A_Data_month;
                }else if(period_val === "year"){
                    temp_data = A_Data_year;
                }else{
                    temp_data = A_Data_day;
                }
                //console.log(temp_data);
                elem_sect = document.querySelector('input[name="sect_r"]:checked');
                elem_supp = document.querySelector('input[name="supp_r"]:checked');
                elem_prod = document.querySelector('input[name="prod_r"]:checked');
                if(elem_sect.value === ""){
                    if(sect_list===""){
                        alert("部門を入力してください。");
                        return;
                    }
                }
                if(elem_supp.value === ""){
                    if(supp_list===""){
                        alert("仕入先を入力してください。");
                        return;
                    }
                }
                if(elem_prod.value === ""){
                    if(prod_list===""){
                        alert("商品を入力してください。");
                        return;
                    }
                }                
                elem_org = document.querySelector('input[name="org_r"]:checked');
                if(elem_org.value === ""){
                    if(org_list===""){
                        alert("店舗を入力してください。");
                        return;
                    }
                }
                working_data = [];

                // date
                temp_data_key = Object.keys(temp_data);
                for( i=0;i<temp_data_key.length;i++ ){
                    loop_date = temp_data_key[i];
                    //console.log("loop_date: "+loop_date+" / elem_str_date: "+elem_str_date );
                    if( loop_date < elem_str_date ){
                        continue;
                    }
                    if( loop_date > elem_end_date ){
                        break;
                    }
                    // org_id
                    org_id_key = Object.keys(temp_data[loop_date]);
                    for(k=0;k<org_id_key.length;k++){
                        loop_org_id = org_id_key[k];
                        if(elem_org.value === ""){
                            // case selected
                            if(isNaN(org_select_val)){
                                    // all selected                            
                                if(org_list.indexOf(loop_org_id) === -1){
                                    continue;
                                }
                            }else if(loop_org_id !== org_select_val){
                                // only the one in select
                                continue;
                            }
                            
                        }
                        // prod_cd
                        prod_key = Object.keys(temp_data[loop_date][loop_org_id]);
                        for(j=0;j<prod_key.length;j++){
                            loop_prod_cd = prod_key[j];
                            loop_row = temp_data[loop_date][loop_org_id][loop_prod_cd];
                            //console.log(loop_org_id + " test " );
                            // loop 特売
                            special_key = Object.keys(loop_row);                           
                            //console.log(special_key);
                            for(l=0;l<special_key.length;l++){
                                special = special_key[l];
                                if(elem_special_sale.checked && special == 0 ){
                                    continue;
                                }
                                
                                loop_row = temp_data[loop_date][loop_org_id][loop_prod_cd][special];
                                //console.log("prod_cd: " + loop_prod_cd + " l: "+l);
                                if(elem_prod.value === ""){
                                    // case selected
                                    if(isNaN(prod_select_val)){
                                        // all selected
                                        if(loop_prod_cd === "" || prod_list.indexOf(loop_prod_cd) === -1){
                                            continue;
                                        }
                                    }else if(loop_prod_cd !== prod_select_val){
                                        // only the one in select
                                        continue;
                                    }
                                }   
                            // sect_cd
                                loop_sect_cd = loop_row["sect_cd"];
                                if(elem_sect.value === ""){
                                    // case selected
                                    if(isNaN(sect_select_val)){
                                        // all selected
                                        if(loop_sect_cd === "" || sect_list.indexOf(loop_sect_cd) === -1){
                                            continue;
                                        }
                                    }else if(loop_sect_cd !== sect_select_val){
                                        // only the one in select
                                        continue;
                                    }
                                }
                            // supp_cd
                                loop_supp_cd = loop_row["supp_cd"];
                                //console.log("loop_supp_cd: " +loop_supp_cd);
                                //console.log("elem_supp.value " +elem_supp.value);
                                if(elem_supp.value === ""){
                                    // case selected
                                    if(isNaN(supp_select_val)){
                                        // all selected
                                        if(loop_supp_cd === "" || supp_list.indexOf(loop_supp_cd) === -1){
                                            continue;
                                        }
                                    }else if(loop_supp_cd !== supp_select_val){
                                        // only the one in select
                                        continue;
                                    }
                                }   

                                if(elem_org.value === "compile"){
                                    org_id_name = "企業計";
                                    if(!nb_row_shown[org_id_name]){
                                        nb_row_shown[org_id_name] = 0;
                                    }                                    
                                    if(!working_data[org_id_name]){
                                        working_data[org_id_name]=[];
                                    }
                                    if(!working_data[org_id_name][loop_prod_cd]){
                                        working_data[org_id_name][loop_prod_cd]=[];
                                    }
                                    if(!working_data[org_id_name][loop_prod_cd][special]){
                                        working_data[org_id_name][loop_prod_cd][special] = JSON.parse(JSON.stringify(loop_row));
                                        loop_working_data =  working_data[org_id_name][loop_prod_cd][special];
                                        if(Number(loop_working_data["prod_sale_amount"]) !== 0){
                                            loop_working_data["res1"]              = (Number(loop_working_data["prod_pure_total"])-Number(loop_working_data["prod_profit"]))/Number(loop_working_data["prod_sale_amount"])*100;
                                            loop_working_data["res2"]              = Number(loop_working_data["prod_pure_total"])/Number(loop_working_data["prod_sale_amount"])*100;
                                        }else{
                                            loop_working_data["res1"]              = 0;
                                            loop_working_data["res1"]              = 0;
                                        }
                                        if(Number(loop_working_data["prod_pure_total"]) !== 0){
                                            loop_working_data["res3"]              = Number(loop_working_data["prod_profit"])/Number(loop_working_data["prod_pure_total"])*100;  
                                        }else{
                                            loop_working_data["res3"]              = 0;
                                        }
                                        //console.log("nb_row_shown[org_id_name]: "+nb_row_shown[org_id_name]+' org_id_name '+org_id_name);
                                        nb_row_shown[org_id_name] += 1;
                                    }else{
                                        loop_working_data =  working_data[org_id_name][loop_prod_cd][special];
                                        loop_working_data["prod_sale_amount"]  = Number(loop_working_data["prod_sale_amount"])+Number(loop_row["prod_sale_amount"]);
                                        loop_working_data["prod_pure_total"]   = Number(loop_working_data["prod_pure_total"])+Number(loop_row["prod_pure_total"]);
                                        loop_working_data["prod_profit"]       = Number(loop_working_data["prod_profit"])+Number(loop_row["prod_profit"]);
                                        if(Number(loop_working_data["prod_sale_amount"]) !== 0){
                                            loop_working_data["res1"]              = (Number(loop_working_data["prod_pure_total"])-Number(loop_working_data["prod_profit"]))/Number(loop_working_data["prod_sale_amount"])*100;
                                            loop_working_data["res2"]              = Number(loop_working_data["prod_pure_total"])/Number(loop_working_data["prod_sale_amount"])*100;
                                        }else{
                                            loop_working_data["res1"]              = 0;
                                            loop_working_data["res1"]              = 0;
                                        }
                                        if(Number(loop_working_data["prod_pure_total"]) !== 0){
                                            loop_working_data["res3"]              = Number(loop_working_data["prod_profit"])/Number(loop_working_data["prod_pure_total"])*100;  
                                        }else{
                                            loop_working_data["res3"]              = 0;
                                        }                                 
                                    }
                                }else{ 
                                    org_id_name = loop_org_id;
                                    if(!nb_row_shown[org_id_name]){
                                        nb_row_shown[org_id_name] = 0;
                                    }                                     
                                    if(!working_data[org_id_name]){
                                        working_data[org_id_name]=[];
                                    }
                                    if(!working_data[org_id_name][loop_prod_cd]){
                                        working_data[org_id_name][loop_prod_cd]=[];
                                    }
                                    if(!working_data[org_id_name][loop_prod_cd][special]){
                                        working_data[org_id_name][loop_prod_cd][special] = JSON.parse(JSON.stringify(loop_row));
                                        loop_working_data =  working_data[org_id_name][loop_prod_cd][special];
                                        if(Number(loop_working_data["prod_sale_amount"]) !== 0){
                                            loop_working_data["res1"]              = (Number(loop_working_data["prod_pure_total"])-Number(loop_working_data["prod_profit"]))/Number(loop_working_data["prod_sale_amount"])*100;
                                            loop_working_data["res2"]              = Number(loop_working_data["prod_pure_total"])/Number(loop_working_data["prod_sale_amount"])*100;
                                        }else{
                                            loop_working_data["res1"]              = 0;
                                            loop_working_data["res1"]              = 0;
                                        }
                                        if(Number(loop_working_data["prod_pure_total"]) !== 0){
                                            loop_working_data["res3"]              = Number(loop_working_data["prod_profit"])/Number(loop_working_data["prod_pure_total"])*100;  
                                        }else{
                                            loop_working_data["res3"]              = 0;
                                        }
                                        nb_row_shown[loop_org_id] += 1;
                                    }else{
                                        loop_working_data =  working_data[org_id_name][loop_prod_cd][special];
                                        loop_working_data["prod_sale_amount"]  = Number(loop_working_data["prod_sale_amount"])+Number(loop_row["prod_sale_amount"]);
                                        loop_working_data["prod_pure_total"]   = Number(loop_working_data["prod_pure_total"])+Number(loop_row["prod_pure_total"]);
                                        loop_working_data["prod_profit"]       = Number(loop_working_data["prod_profit"])+Number(loop_row["prod_profit"]);
                                        if(Number(loop_working_data["prod_sale_amount"]) !== 0){
                                            loop_working_data["res1"]              = (Number(loop_working_data["prod_pure_total"])-Number(loop_working_data["prod_profit"]))/Number(loop_working_data["prod_sale_amount"])*100;
                                            loop_working_data["res2"]              = Number(loop_working_data["prod_pure_total"])/Number(loop_working_data["prod_sale_amount"])*100;
                                        }else{
                                            loop_working_data["res1"]              = 0;
                                            loop_working_data["res1"]              = 0;
                                        }
                                        if(Number(loop_working_data["prod_pure_total"]) !== 0){
                                            loop_working_data["res3"]              = Number(loop_working_data["prod_profit"])/Number(loop_working_data["prod_pure_total"])*100;  
                                        }else{
                                            loop_working_data["res3"]              = 0;
                                        }
                                    }
                                }

                                //console.log("end"+loop_date+" "+ loop_org_id+ " "+loop_sect_cd);
                                //working_data[loop_org_id][loop_prod_cd] = JSON.parse(JSON.stringify(temp_data[loop_date][loop_org_id][loop_prod_cd]));  
                            }
                        }
                    }
                }
                

                //console.log(working_data[2]);
                if(Object.keys(working_data).length === 0 ){
                    alert("データがありません。");
                    document.getElementById("btn_csv").hidden = true;
                }else{
                    document.getElementById("btn_csv").hidden = false;
                }
                //working_data = sort_data(working_data,1,"prod_cd");
                //show_data(working_data);
                sort_tbody('prod_cd');
            };
            function rank_show(){
                if(rank_on.checked){
                    $("#table_id thead th:nth-child(6)").show();
                    $("#table_id tbody tr td:nth-child(6)").show();
                    $("#table_id tfoot tr td:nth-child(6)").show();                   
                }else{
                    $("#table_id thead th:nth-child(6)").hide();
                    $("#table_id tbody tr td:nth-child(6)").hide();
                    $("#table_id tfoot tr td:nth-child(6)").hide();              
                }                
            }
            // add　org_id
            function show_data(t_data){
                //console.log(t_data);
                date_str_id = "start_"+date_mode;
                date_end_id = "end_"+date_mode;                
                elem_tbody=document.getElementById("table_body");
                elem_tbody.innerHTML="";
                t_cumul_data = [];
                t_cumul_data["total"]=[];
                t_cumul_data["total"]["pure_total"] = 0;
                t_cumul_data["total"]["sale_amount"]= 0;
                t_cumul_data["total"]["profit"]     = 0;
                t_cumul_data["total"]["res1"]       = 0;
                t_cumul_data["total"]["res2"]       = 0;
                t_cumul_data["total"]["res3"]       = 0;                
                function insert_row(row){
                    //console.log("row to print");
                    //console.log(row);
                    trow     = elem_tbody.insertRow();
                    if(row["background"]){
                        //console.log(row);
                        trow.style.backgroundColor = row["background"];
                    }
                    calc1 = 0;
                    calc2 = 0;
                    calc3 = 0;
                    org_val             = trow.insertCell(0);
                    special_val         = trow.insertCell(1);
                    prod_cd_val         = trow.insertCell(2);
                    prod_nm_val         = trow.insertCell(3);
                    prod_tax_val        = trow.insertCell(4);
                    prod_capa_nm_val    = trow.insertCell(5);
                    rank_val            = trow.insertCell(6);
                    res1_val            = trow.insertCell(7);
                    res2_val            = trow.insertCell(8);
                    sale_amount_val     = trow.insertCell(9);
                    pure_total_val      = trow.insertCell(10);
                    profit_val          = trow.insertCell(11); 
                    res3_val            = trow.insertCell(12); 
                    
                    org_val.innerHTML           = row["org_nm"];
                    special_val.innerHTML       = row["special"];
                    prod_cd_val.innerHTML       = row["prod_cd"];
                    prod_nm_val.innerHTML       = row["prod_nm"];
                    prod_tax_val.innerHTML      = row["prod_tax"];
                    prod_capa_nm_val.innerHTML  = row["prod_capa_nm"];
                    rank_val.innerHTML          = row["rank"];
                    sale_amount_val.innerHTML   = numberWithCommas(row["sale_amount"]).split('.')[0];
                    pure_total_val.innerHTML    = numberWithCommas(row["pure_total"]).split('.')[0];
                    profit_val.innerHTML        = numberWithCommas(row["profit"]).split('.')[0];
                    if(row["sale_amount"] == 0){
                        calc1 = 0;
                        calc2 = 0;
                    }else{
                        calc1  = (Number(row["pure_total"])-Number(row["profit"]))/Number(row["sale_amount"]);
                        calc2  = Number(row["pure_total"])/Number(row["sale_amount"]);
                    }
                    res1_val.innerHTML = numberWithCommas(calc1,2);
                    res2_val.innerHTML = numberWithCommas(calc2).split('.')[0];
                    if(row["pure_total"] == 0 ){
                        calc3 = 0;
                    }else{
                        calc3 = Number(row["profit"])/Number(row["pure_total"])*100;  
                    }
                    res3_val.innerHTML = numberWithCommas(calc3,2);
                    if(row["prod_cd"] !== '合計'){
                        t_cumul_data["total"]["pure_total"]     += Number(row["pure_total"]);
                        t_cumul_data["total"]["sale_amount"]    += Number(row["sale_amount"]);
                        t_cumul_data["total"]["profit"]         += Number(row["profit"]);/*
                        t_cumul_data["total"]["res1"]           += calc1;
                        t_cumul_data["total"]["res2"]           += calc2;
                        t_cumul_data["total"]["res3"]           += calc3;*/
                    }
                }
                function insert_footer(row){
                    elem_tfoot=document.getElementById("table_foot");
                    elem_tfoot.innerHTML="";
                    elem_tfoot.innerHTML="<tr><th></th></tr>";

                    trow     = elem_tfoot.insertRow();
                    org_val             = trow.insertCell(0);
                    special_val         = trow.insertCell(1);
                    prod_cd_val         = trow.insertCell(2);
                    prod_nm_val         = trow.insertCell(3);
                    prod_tax_val        = trow.insertCell(4);
                    prod_capa_nm_val    = trow.insertCell(5);
                    rank_val            = trow.insertCell(6);
                    res1_val            = trow.insertCell(7);
                    res2_val            = trow.insertCell(8);
                    sale_amount_val     = trow.insertCell(9);
                    pure_total_val      = trow.insertCell(10);
                    profit_val          = trow.insertCell(11); 
                    res3_val            = trow.insertCell(12); 
                    
                    org_val.innerHTML           = "";
                    special_val.innerHTML       = "";
                    prod_cd_val.innerHTML       = "総合計";
                    prod_nm_val.innerHTML       = "";
                    prod_tax_val.innerHTML      = "";
                    prod_capa_nm_val.innerHTML  = "";
                    sale_amount_val.innerHTML   = numberWithCommas(row["sale_amount"]).split('.')[0];
                    pure_total_val.innerHTML    = numberWithCommas(row["pure_total"]).split('.')[0];
                    profit_val.innerHTML        = numberWithCommas(row["profit"]).split('.')[0];
                    if(row["sale_amount"] == 0){
                        calc1 = 0;
                        calc2 = 0;
                    }else{
                        calc1  = (Number(row["pure_total"])-Number(row["profit"]))/Number(row["sale_amount"]);
                        calc2  = Number(row["pure_total"])/Number(row["sale_amount"]);
                    }
                    res1_val.innerHTML = numberWithCommas(calc1,2);
                    res2_val.innerHTML = numberWithCommas(calc2).split('.')[0];
                    if(row["pure_total"] == 0 ){
                        calc3 = 0;
                    }else{
                        calc3 = Number(row["profit"])/Number(row["pure_total"])*100;  
                    }
                    res3_val.innerHTML = numberWithCommas(calc3,2);                    
                    /*
                    if(!elem_special_sale.checked){
                        document.querySelector('#table_id thead tr th:nth-child(2)').hidden = true;
                        document.querySelector('#table_id tbody tr td:nth-child(2)').hidden = true;
                        document.querySelector('#table_id tfoot tr td:nth-child(2)').hidden = true;
                    }else{
                        document.querySelector('#table_id thead tr th:nth-child(2)').hidden = false;
                        document.querySelector('#table_id tbody tr td:nth-child(2)').hidden = false;
                        document.querySelector('#table_id tfoot tr td:nth-child(2)').hidden = false;                        
                    }*/
                }
                org_id_key = Object.keys(t_data);
                org_nm = "";
                elem_str_date = document.getElementById(date_str_id).value.replace(/\//g,"");
                elem_end_date = document.getElementById(date_end_id).value.replace(/\//g,"");
                // 店舗
                if(asc["org_id"]){
                    if(asc["org_id"] === -1){
                        //console.log("here");
                        org_id_key.reverse();
                    }
                }
                
                //console.log(org_id_key);
                for(i=0;i<org_id_key.length;i++){
                    nb_row = 1;
                    loop_org_id = org_id_key[i];
                    prod_cd_key = Object.keys(t_data[loop_org_id]);
                    cumul=[];
                    cumul["sale_amount"]     = 0;
                    cumul["pure_total"]      = 0;
                    cumul["profit"]          = 0;                    
                    // 商品
                    for(j=0;j<prod_cd_key.length;j++){
                        loop_prod_cd = prod_cd_key[j];
                        special_key = Object.keys(t_data[loop_org_id][loop_prod_cd]);
                        for(k=0;k<special_key.length;k++){
                            special = special_key[k];
                            loop_row = t_data[loop_org_id][loop_prod_cd][special];
                            if(j === 0 && k === 0){
                                if(loop_org_id === "企業計"){
                                    org_nm = "企業計";
                                }else{
                                    org_nm = loop_row["org_nm"];
                                }
                            }else{
                                org_nm = "";
                            }                            
                            
                            i_row = [];
                            i_row["org_nm"]          = org_nm;
                            i_row["prod_cd"]         = loop_row["prod_cd"];
                            i_row["prod_nm"]         = loop_row["prod_nm"];
                            i_row["prod_tax"]        = loop_row["prod_tax"];
                            i_row["prod_capa_nm"]    = loop_row["prod_capa_nm"];
                            asc_key = Object.keys(asc)[0];
                            if(asc[asc_key] === -1 && asc_key !== 'org_id' ){
                                if(limit_r.value && limit_r.value < nb_row_shown[loop_org_id] ){
                                    max_row = Number(limit_r.value);
                                }else{
                                    max_row = Number(nb_row_shown[loop_org_id]);
                                }
                                //console.log("loop_org_id: "+loop_org_id+' max_row: '+max_row + ' nb_row_shown[loop_org_id]: '+nb_row_shown[loop_org_id]);
                                i_row['rank'] = max_row + 1 - nb_row;
                            }else{
                                i_row['rank']            = nb_row;
                            }
                            /*i_row['rank']            = nb_row;
                            if(Object.keys(asc).length > 0){
                                if(asc[Object.keys(asc)[0]] === -1 && limit_r.value){
                                    i_row['rank'] = limit_r.value - nb_row+1;
                                }
                            }*/
                            i_row["sale_amount"]     = loop_row["prod_sale_amount"];
                            i_row["pure_total"]      = loop_row["prod_pure_total"];
                            i_row["profit"]          = loop_row["prod_profit"];                          
                            i_row["special"]         = "";
                            //console.log(loop_prod_cd);
                            //console.log(A_lst_spe_sales[loop_org_id]);
                            if( special == 1 ){
                                i_row["special"] = '⚫';
                            }
                            //console.log(i_row);

                            if( (limit_r.value && limit_r.value >= nb_row) || !limit_r.value ){
                                insert_row(i_row);
                                org_nm  = "";
                                nb_row += 1;
                                cumul["sale_amount"] += Number(loop_row["prod_sale_amount"]);
                                cumul["pure_total"]  += Number(loop_row["prod_pure_total"]);
                                cumul["profit"]      += Number(loop_row["prod_profit"]);                                  
                            }else{
                                break;
                            }
                        }
                    }
                    i_row = [];
                    i_row["background"]      = "lightgrey" ;
                    i_row["org_nm"]          = '';
                    i_row["prod_cd"]         = "合計";
                    i_row["prod_nm"]         = "";
                    i_row["prod_tax"]        = "";
                    i_row["prod_capa_nm"]    = ""; 
                    i_row["sale_amount"]     = cumul["sale_amount"];
                    i_row["pure_total"]      = cumul["pure_total"];
                    i_row["profit"]          = cumul["profit"];                          
                    i_row["special"]         = "";
                    i_row['rank']            = "";
                    insert_row(i_row);
                }
                
                insert_footer(t_cumul_data["total"]);
                rank_show();
            }
            function sort_tbody(col_to_sort,title = '商品'){
                col_sort_type = "";
                if( !asc[col_to_sort] || asc[col_to_sort] === 0 ){
                    col_sort_type = 1;
                }else{
                    col_sort_type = asc[col_to_sort] * -1;
                }
                rank_title.innerHTML = title+'<br />順位';
                //console.log(col_to_sort + ": "+asc[col_to_sort]);
                elem_table_id = document.getElementById("table_id");
                elem_thead = elem_table_id.getElementsByTagName('THEAD')[0];
                elem_th = elem_thead.getElementsByTagName('TH');
                for(i=0;i<elem_th.length;i++){
                    //console.log("i: "+i);
                    //console.log(elem_th[i]);
                    elem_th[i].innerHTML = elem_th[i].innerHTML.replace(' ▲',"").replace(' ▼',"");
                    if( elem_th[i].outerHTML.indexOf("'"+col_to_sort+"'") !== -1 ){
                        if( col_sort_type === 1 ){
                            elem_th[i].innerHTML = elem_th[i].innerHTML + ' ▲';
                        }else{
                            elem_th[i].innerHTML = elem_th[i].innerHTML + ' ▼';
                        }
                    }
                }
                asc = [];
                asc[col_to_sort] = col_sort_type;
                if(col_to_sort === 'org_id'){
                    col_to_sort     = 'prod_cd';
                    col_sort_type   = 1;
                }
                //console.log(col_to_sort);
                working_data = sort_data(working_data,col_sort_type, col_to_sort);
                show_data(working_data);
            }
            window.onload = function () {
                creat_listener();
                radio_change_management();
                today = new Date();
                document.getElementById("end_date").value = today.toISOString().slice(0,10).replace(/-/g,"\/"); 
                today.setMonth(today.getMonth()-1);
                document.getElementById("start_date").value = today.toISOString().slice(0,10).replace(/-/g,"\/"); 
                var empty_array = [];
                modal_create_select("sect_select",empty_array);
                modal_create_select("org_select",empty_array);
                modal_create_select("prod_select",empty_array);
                modal_create_select("supp_select",empty_array);                
            };

        </script>

        <STYLE type="text/css">
            select{
                min-width: 10em;
            }
            #sb-site{
                padding-left: 5px;
            }
            table th {
              color: #fff;
              background: #0D0D70;
              border-left:1px solid #000000;
              border-right:1px solid #000000;
              border-top:1px solid #000000;
              border-bottom:1px solid #000000;
              line-height: 120%;
              text-align: center;
              text-shadow:0 -1px 0 rgba(34,85,136,0.9);
              box-shadow: 0px 1px 1px rgba(255,255,255,0.3) inset;
              height:25px;
            }
            #search_param{
                overflow: hidden; 
            }
            .no_overflow{
                float: left; 
            }
            .block_left{
                overflow: hidden;
                float: left;
            }
            .field_title {
                float: left;
                /*display:flex;*/
                align-items:center;
                background: #0D0D70;
                height: 6em;
                color: white;
                text-align: center;
                padding: 5px;
				padding-top: 20px;
                border: 1px solid black;
				min-width: 4em;
            }
            .field_data {
                padding: 5px 20px 5px 20px;
                float : left;
                height: 6em;
                border: 1px solid black;            
            }
            .field_data_bottom {
                padding: 5px 20px 5px 20px;
                float : left;
                height: 6em;
                border:  1px solid black;            
            }
            .field_title_large {
                float: left;
                display:flex;
                align-items:center;
                background: #0D0D70;
                height: 12em;
                color: white;
                text-align: center;
                padding: 5px;
                border: 1px solid black;
            }
            .field_data_large {
                padding: 5px 20px 5px 20px;
                float : left;
                height: 12em;
                border: 1px solid black;
            }
            .field_title_small {
                float: left;
                display:flex;
                align-items:center;
                background: #0D0D70;
                height: 6em;
                color: white;
                text-align: center;
                padding: 5px;
                border: 1px solid black;
            }
            .field_data_small {
                padding: 5px 20px 5px 20px;
                float : left;
                height: 6em;
                border: 1px solid black;
            } 
            .field_long{
                width: 40em;
            }
            .field_short{
                width: 3em;
            }
            .cl_btn{
                /*width: 20em;*/
                padding-top: 14px;
            }
            #btn_search{
               /*margin-left: 45px; */
            }
            #btn_csv{
                /*margin-left: 20px;*/
                margin-top: 2px;               
            }
            #screen_name_d{
                display:flex;
                align-items:center;
 
            }
            #supplier_t_d{
                padding-top: 15px;
            }
            #product_t_d{
                padding-top: 7px;
            }
            #department_t_d{
                padding-top: 15px;
            }
            #org_d{
                padding-top: 7px;
            }
            #limit_t_d{
                padding-top: 18px;
            }
/* table css            */
            .table_container {
                overflow: hidden;                
                padding: 0;
            }
            #table_id  {
                max-height: 40em;
                display: flex;
                flex-flow: column;
                height: 100%;
                width: 100%;
                padding: 0;
                border-spacing: 0;  
            }
            #table_id  thead,
            #table_id  tfoot{
                /* head takes the height it requires, 
                and it's not scaled when table is resized */
                flex: 0 0 auto;
                width: calc(100% - 18px);
            }
            #table_id  tbody {
                /* body takes all the remaining available space */
                /*flex: 1 1 auto;*/
                display: block;
                overflow-y: scroll;
                padding: 0;
            }
            #table_id  tbody tr,
            #table_id  tfoot tr {
                width: 100%;
            }
            #table_id thead,
            #table_id tbody tr,
            #table_id  tfoot tr{
                display: table;
                table-layout: fixed;
                padding: 0;
                background-color: #fff;
            }

            #table_id thead th {
                background: #0D0D70;                
                border: 1px solid #AAA;
                color: white;
                text-align: center;
                padding: 0;
                border-collapse: collapse;
            }
            #table_id tbody td,
            #table_id tfoot td{
                
                border: 1px solid #444;
                padding: 0 2px 0 2px;
                text-align: center; 
                border-collapse: collapse;
            }
            #table_id thead th:first-child,
            #table_id tbody tr td:first-child,
            #table_id tfoot tr td:first-child {
              width: 5em;
            }
            #table_id thead th:nth-child(2),
            #table_id tbody tr td:nth-child(2),
            #table_id tfoot tr td:nth-child(2){
                width: 3em;
            }
            #table_id thead th:nth-child(3),
            #table_id tbody tr td:nth-child(3),
            #table_id tfoot tr td:nth-child(3){
                width: 9em;
            }
            #table_id thead th:nth-child(5),
            #table_id tbody tr td:nth-child(5),
            #table_id tfoot tr td:nth-child(5){
                width: 10em;
            } 
            #table_id thead th:nth-child(6),
            #table_id tbody tr td:nth-child(6),
            #table_id tfoot tr td:nth-child(6){
                width: 5em;
            }
            #table_id thead th:nth-child(7),
            #table_id tbody tr td:nth-child(7),
            #table_id tfoot tr td:nth-child(7){
                width: 7em;
            }
            #table_id thead th:nth-child(8),
            #table_id tbody tr td:nth-child(8),
            #table_id tfoot tr td:nth-child(8){
                width: 7em;
            }
            #table_id thead th:nth-child(9),
            #table_id tbody tr td:nth-child(9),
            #table_id tfoot tr td:nth-child(9){
                width: 7em;
            }
            #table_id thead th:nth-child(10),
            #table_id tbody tr td:nth-child(10),
            #table_id tfoot tr td:nth-child(10){
                width: 7em;
            }
            #table_id thead th:nth-child(11),
            #table_id tbody tr td:nth-child(11),
            #table_id tfoot tr td:nth-child(11){
                width: 7em;
            }
            #table_id thead th:nth-child(12),
            #table_id tbody tr td:nth-child(12),
            #table_id tfoot tr td:nth-child(12){
                width: 6em;
            }            
            #table_id tbody tr td,
            #table_id tfoot tr td{
                text-align: right;
            }
            #table_id tbody tr td:first-child,
            #table_id tfoot tr td:first-child ,
            #table_id tbody tr td:nth-child(3),
            #table_id tfoot tr td:nth-child(3),
            #table_id tbody tr td:nth-child(4),
            #table_id tfoot tr td:nth-child(4),
            #table_id tbody tr td:nth-child(5),
            #table_id tfoot tr td:nth-child(5){
                text-align: left;
            }
            #table_id tbody tr td:nth-child(2),
            #table_id tfoot tr td:nth-child(2){
                text-align: center; 
            }
            .hasDatepicker, .hasYmpicker{
                margin-top: 3px;
            }
        </STYLE>

    </head>
    <body>
        <?php
        if( isset($_GET['home']) ) {
            if( "1" ==  $_GET['home'] ){
                include("../home/View/Common/PageHeader.php");
            }else{
                include("Common/PageHeader.php");
            }
        }else{
                include("Common/PageHeader.php");
        }
        ?>

        <!-- Site -->
        <div id="sb-site">
            <div id="search_param">
                <div id="screen_name_t" class="field_title_large">
                    帳票			
                </div>
                <div id="screen_name_d" class="field_data_large">
                    商品別実績
                </div>
                <div class="no_overflow">
                    <div id="period_t" class="field_title">
                        期間<br />指定<!--文字修正　2019/12/01　柴田-->			
                    </div>  
                    <div id="period_d" class="field_data">
                        <input type="radio" name="period" id="day" value="day" checked > 日別<br />
                        <input type="radio" name="period" id="month" value="month"> 月別&nbsp;&nbsp;
                        <!-- day -->
                        <input type="text" title="開始" id="start_date" name="start_date" size="10" >
                        <input type="text" title="終了" id="end_date" name="end_date" size="10" >
                        <!-- month -->
                        <input type="text" title="開始" id="start_dateM" name="start_dateM" size="10" hidden>
                        <input type="text" title="終了" id="end_dateM" name="end_dateM" size="10" hidden>                    
                        <!-- year -->
                        <input type="text" title="開始" id="start_year" name="start_year" size="10" hidden>
                        <input type="text" title="終了" id="end_year" name="end_year" size="10" hidden>                     
                        <br />
                        <input type="radio" name="period" id="year" value="year"> 年別
                    </div>
                </div>
                <div class="no_overflow">
                    <div id="org_t" class="field_title">
                        グループ<br />選択			
                    </div>
                    <div id="org_d" class="field_data">
                        <input type="radio" name="org_r" value="compile"> 企業計<br />
                        <input type="radio" name="org_r" value="all" checked> 全店<br />
                        <input type="radio" name="org_r" value=""> 店舗指定&nbsp;&nbsp;
                        <select id="org_select" name="org_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                    </div>
                </div>
                <div class="no_overflow">
                    <div id="department_t" class="field_title">
                        部門<br />選択	
                    </div>
                    <div id="department_t_d" class="field_data">

                        <input type="radio" name="sect_r" value="all" checked> 全部門<br />
                        <input type="radio" name="sect_r" value=""> 部門指定&nbsp;&nbsp;
                        <select id="sect_select" name="sect_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                    </div>
                </div>
                <div class="no_overflow">
                    <div id="product_t" class="field_title">
                        商品<br />選択	
                    </div>
                    <div id="product_t_d" class="field_data_bottom">
                        <!--クラス（下線のみ表示）変更 2019/11/29 柴田 -->
                        <input type="radio" name="prod_r" value="all" checked> 全商品<br />
                        <input type="radio" name="prod_r" value=""> 商品指定&nbsp;&nbsp;
                        <select id="prod_select" name="prod_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                        <br /><input type="checkbox" id="special_sale" value="special_sale"> 特売商品のみ
                    </div>
                </div>
                <div class="no_overflow">
                    <div class="no_overflow">
                        <div id="supplier_t" class="field_title">
                            仕入先<br />選択	
                        </div>
                        <div id="supplier_t_d" class="field_data_bottom">
                             <!--クラス（下線のみ表示）変更 2019/11/29 柴田 -->
                            <input type="radio" name="supp_r" value="all" checked> 全仕入先<br />
                            <input type="radio" name="supp_r" value=""> 仕入先指定&nbsp;&nbsp;
                            <select id="supp_select" name="supp_select" disabled onchange="modal_select_mgt(event)"><option value="no">&nbsp;</option></select>
                        </div> 
                    </div>
                    <div class="no_overflow">
                        <div id="limit_t" class="field_title">
                            抽出<br />件数	
                        </div>
                        <div id="limit_t_d" class="field_data_bottom">
                             <!--クラス（下線のみ表示）変更 2019/11/29 柴田 -->
                            <input type="text" id="limit_r" maxlength="3" class="field_short" oninput="this.value=this.value.replace(/[^\d]/,'')">
                            <br />
                            <input type="checkbox" id="rank_on" value="rank_on" checked onchange="rank_show()"> 順位表示
                        </div> 
                    </div>
                    <div class="no_overflow" hidden>
                        <div id="kubun_t" class="field_title_small">
                                区分選択		
                        </div>
                        <div id="kubun_t_d" class="field_data_small field_long">
                        </div>
                    </div>
                    <div id="action_d" class="field_data_small cl_btn">
                        <button type="button" id="btn_search" onclick="search_data(event)" >検索</button>&nbsp;&nbsp;<br />
                        <button type="button" id="btn_csv" onclick="csv_print(event)" hidden>CSV出力</button>
                    </div> 
                </div> 
                
            </div>
            <!-- The Modal -->
            <div id="modal_sect" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modaldepartment.html"); ?>
                </div>
            </div>
            
            <div id="modal_org" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modalorganization.html"); ?>
                </div>
            </div>            
            <div id="modal_prod" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modalproduct.html"); ?>
                </div>
            </div> 
            <div id="modal_supp" class="modal">
                <!-- Modal content -->
                <div class="modal-content">
                    <?php include("../modal/View/Modalsupplier.html"); ?>
                </div>
            </div> 
            <br />
            <div id="data_show"  class="table_container">
                <table id="table_id">
                    <thead id="table_head">
                        <tr>
                            <th onclick="sort_tbody('org_id','商品')"><u>店舗名</u></th>
                            <th>特売</th>
                            <th onclick="sort_tbody('prod_cd','商品')"><u>商品コード</u></th>
                            <th onclick="sort_tbody('prod_nm','商品')"><u>商品名</u></th>
                            <th onclick="sort_tbody('prod_tax','税率')"><u>税率</u></th>
                            <th>規格容量</th>
                            <th id="rank_title">商品順位</th>
                            <th onclick="sort_tbody('res1','平均原価')"><u>平均原価</u></th>
                            <th onclick="sort_tbody('res2','平均売価')"><u>平均売価</u></th>
                            <th onclick="sort_tbody('prod_sale_amount','売上数量')"><u>売上数量</u></th>
                            <th onclick="sort_tbody('prod_pure_total','売上金額')"><u>売上金額</u></th>
                            <th onclick="sort_tbody('prod_profit','粗利金額')"><u>粗利金額</u></th>
                            <th onclick="sort_tbody('res3','粗利率')"><u>粗利率</u></th>
                        </tr>
                    </thead>
                    <tbody id="table_body">
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>                            
                            <td></td>                            
                        </tr>                        
                    </tbody>
                    <tfoot id="table_foot">
                    </tfoot>
                </table>
            </div>
            
        </div>
        <script type="text/javascript">

            ptypprod_detail     = '<?php echo json_encode($prod_detail); ?>';
            ptypprod_detail = ptypprod_detail.replace(/\\n/g, "")  
                           .replace(/\\'/g, "")
                           .replace(/\\"/g, '')
                           .replace(/\\&/g, "")
                           .replace(/\\r/g, "")
                           .replace(/\\t/g, "")
                           .replace(/\\b/g, "")
                           .replace(/\\f/g, "");  
            ptypprod_detail     = ptypprod_detail.replace(/[\u0000-\u001F]+/g,"");                   
            data_prod           = JSON.parse(ptypprod_detail);            
            ptypdata            = '<?php echo json_encode($data); ?>';
            ptypdata    = ptypdata.replace(/\\n/g, "")  
                           .replace(/\\'/g, "")
                           .replace(/\\"/g, '')
                           .replace(/\\&/g, "")
                           .replace(/\\r/g, "")
                           .replace(/\\t/g, "")
                           .replace(/\\b/g, "")
                           .replace(/\\f/g, "");  
            ptypdata     = ptypdata.replace(/[\u0000-\u001F]+/g,"");             
            A_Data       = JSON.parse(ptypdata);  

          

            // create data set for day case, month case and year case
            A_Data_day = []; // day
            A_Data_month = []; // month
            A_Data_year = [];  // year
            // fill month data and year data
            cumul=[];
            cumul["month"]=[];
            cumul["year"]=[];
            for(i=0;i<A_Data.length;i++){
                date_day = A_Data[i]["proc_date"];
                date_month = A_Data[i]["proc_date"].substr(0,6); 
                date_year = A_Data[i]["proc_date"].substr(0,4);                
                org_id    = A_Data[i]["org_id"];
                prod_cd   = A_Data[i]["prod_cd"];
                sect_cd   = A_Data[i]["sect_cd"];
                supp_cd   = A_Data[i]["supp_cd"];

                // day
                if(!A_Data_day[date_day]){
                    A_Data_day[date_day] = [];
                    A_Data_day[date_day][org_id] = [];
                    A_Data_day[date_day][org_id][prod_cd] = [];
                }else if(!A_Data_day[date_day][org_id]){
                    A_Data_day[date_day][org_id] = [];
                    A_Data_day[date_day][org_id][prod_cd] = [];
                }else if(!A_Data_day[date_day][org_id][prod_cd]){
                    A_Data_day[date_day][org_id][prod_cd] = [];
                }
                A_Data_day[date_day][org_id][prod_cd][A_Data[i]["special"]] = JSON.parse(JSON.stringify(A_Data[i]));

                // month

                if(!cumul["month"][date_month]){
                    cumul["month"][date_month] = [];
                }
                if(!cumul["month"][date_month][org_id]){
                    cumul["month"][date_month][org_id] = [];
                }
                if(!cumul["month"][date_month][org_id][prod_cd]){
                    cumul["month"][date_month][org_id][prod_cd] = [];                  
                }
                if(!cumul["month"][date_month][org_id][prod_cd][A_Data[i]["special"]]){
                    cumul["month"][date_month][org_id][prod_cd][A_Data[i]["special"]] = JSON.parse(JSON.stringify(A_Data[i]));
                    cumul["month"][date_month][org_id][prod_cd][A_Data[i]["special"]]["proc_date"] = date_month;                    
                }else{

                        row_month_loop = cumul["month"][date_month][org_id][prod_cd][A_Data[i]["special"]];
                        //console.log("init4");
                        //console.log(A_Data[i]["pure_total"]);
                        //console.log(cumul["month"][date_month][org_id][sect_cd]["pure_total"]);                         
                        row_month_loop["proc_date"]         = date_month;
                        row_month_loop["prod_sale_amount"]  = Number(row_month_loop["prod_sale_amount"])+Number(A_Data[i]["prod_sale_amount"]);
                        row_month_loop["prod_pure_total"]   = Number(row_month_loop["prod_pure_total"])+Number(A_Data[i]["prod_pure_total"]);
                        row_month_loop["prod_profit"]       = Number(row_month_loop["prod_profit"])+Number(A_Data[i]["prod_profit"]);
                        row_month_loop["res1"]              = (Number(row_month_loop["prod_pure_total"])-Number(row_month_loop["prod_profit"]))/Number(row_month_loop["prod_sale_amount"])*100;
                        row_month_loop["res2"]              = Number(row_month_loop["prod_pure_total"])/Number(row_month_loop["prod_sale_amount"])*100;
                        row_month_loop["res3"]              = Number(row_month_loop["prod_profit"])/Number(row_month_loop["prod_pure_total"])*100;                    
                        if(row_month_loop["prod_sale_amount"] == 0){
                            row_month_loop["res1"] = 0;
                            row_month_loop["res2"] = 0;
                        }
                        if(row_month_loop["prod_pure_total"] == 0){
                            row_month_loop["res3"] = 0;
                        }
                }

                // year
                if(!cumul["year"][date_year]){
                    cumul["year"][date_year] = [];
                }
                if(!cumul["year"][date_year][org_id]){
                    cumul["year"][date_year][org_id] = [];
                }
                if(!cumul["year"][date_year][org_id][prod_cd]){
                    cumul["year"][date_year][org_id][prod_cd] = [];                  
                }
                if(!cumul["year"][date_year][org_id][prod_cd][A_Data[i]["special"]]){
                    cumul["year"][date_year][org_id][prod_cd][A_Data[i]["special"]] = JSON.parse(JSON.stringify(A_Data[i]));
                    cumul["year"][date_year][org_id][prod_cd][A_Data[i]["special"]]["proc_date"] = date_month;                    
                }else{

                        row_year_loop = cumul["year"][date_year][org_id][prod_cd][A_Data[i]["special"]] ;
                        //console.log("init4");
                        //console.log(A_Data[i]["pure_total"]);
                        //console.log(cumul["year"][date_year][org_id][sect_cd]["pure_total"]);                         
                        row_year_loop["proc_date"]         = date_year;
                        row_year_loop["prod_sale_amount"]  = Number(row_year_loop["prod_sale_amount"])+Number(A_Data[i]["prod_sale_amount"]);
                        row_year_loop["prod_pure_total"]   = Number(row_year_loop["prod_pure_total"])+Number(A_Data[i]["prod_pure_total"]);
                        row_year_loop["prod_profit"]       = Number(row_year_loop["prod_profit"])+Number(A_Data[i]["prod_profit"]);
                        row_year_loop["res1"]              = (Number(row_year_loop["prod_pure_total"])-Number(row_year_loop["prod_profit"]))/Number(row_year_loop["prod_sale_amount"])*100;
                        row_year_loop["res2"]              = Number(row_year_loop["prod_pure_total"])/Number(row_year_loop["prod_sale_amount"])*100;
                        row_year_loop["res3"]              = Number(row_year_loop["prod_profit"])/Number(row_year_loop["prod_pure_total"])*100;                    
                        if(row_year_loop["prod_sale_amount"] == 0){
                            row_year_loop["res1"] = 0;
                            row_year_loop["res2"] = 0;
                        }                   
                        if(row_year_loop["prod_pure_total"] == 0){
                            row_year_loop["res3"] = 0;
                        }
                }                   
            }
            A_Data_month = cumul["month"]; // month
            A_Data_year  = cumul["year"];  // year 

            working_data = [];
        </script>

    </body>        
</html>
